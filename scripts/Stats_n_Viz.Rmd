---
title: "alff"
output:
  html_document: default
  pdf_document: default
date: "2023-07-13"
---

```{r}
library(reshape2)
library(ggplot2)
library(visreg)
```

```{r}
# prop angles
rs1=read.csv('~/Downloads/P50 MDMA/rs1_propsMerged.csv',header=F)
rs2=read.csv('~/Downloads/P50 MDMA/rs2_propsMerged.csv',header=F)
emo=read.csv('~/Downloads/P50 MDMA/emotion_propsMerged.csv',header=F)
gambling=read.csv('~/Downloads/P50 MDMA/gambling_propsMerged.csv',header=F)
wm=read.csv('~/Downloads/P50 MDMA/wm_propsMerged.csv',header=F)
# set colnames
#colnames(rs1)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(rs2)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(emo)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(gambling)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(wm)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
rs1$Task='rs'
rs2$Task='rs2'
emo$Task='emotion'
gambling$Task='gambling'
wm$Task='wm'

# remove subj 4
rs1=rs1[-c(4),]
rs2=rs2[-c(4),]
emo=emo[-c(4),]
gambling=gambling[-c(4),]
wm=wm[-c(4),]

# this is going to be ugly but simple
# manually pair columns as sep. observations of baseline, placebo, 80, 120mg
rs1bv=data.frame(cbind(rs1$V1,rs1$V5))
rs1p=data.frame(cbind(rs1$V2,rs1$V6))
rs1m1=data.frame(cbind(rs1$V3,rs1$V7))
rs1m2=data.frame(cbind(rs1$V4,rs1$V8))
colnames(rs1bv)=c('TDProp','RemTRs')
colnames(rs1p)=c('TDProp','RemTRs')
colnames(rs1m1)=c('TDProp','RemTRs')
colnames(rs1m2)=c('TDProp','RemTRs')

rs2bv=data.frame(cbind(rs2$V1,rs2$V5))
rs2p=data.frame(cbind(rs2$V2,rs2$V6))
rs2m1=data.frame(cbind(rs2$V3,rs2$V7))
rs2m2=data.frame(cbind(rs2$V4,rs2$V8))
colnames(rs2bv)=c('TDProp','RemTRs')
colnames(rs2p)=c('TDProp','RemTRs')
colnames(rs2m1)=c('TDProp','RemTRs')
colnames(rs2m2)=c('TDProp','RemTRs')

emobv=data.frame(cbind(emo$V1,emo$V5))
emop=data.frame(cbind(emo$V2,emo$V6))
emom1=data.frame(cbind(emo$V3,emo$V7))
emom2=data.frame(cbind(emo$V4,emo$V8))
colnames(emobv)=c('TDProp','RemTRs')
colnames(emop)=c('TDProp','RemTRs')
colnames(emom1)=c('TDProp','RemTRs')
colnames(emom2)=c('TDProp','RemTRs')

gamblingbv=data.frame(cbind(gambling$V1,gambling$V5))
gamblingp=data.frame(cbind(gambling$V2,gambling$V6))
gamblingm1=data.frame(cbind(gambling$V3,gambling$V7))
gamblingm2=data.frame(cbind(gambling$V4,gambling$V8))
colnames(gamblingbv)=c('TDProp','RemTRs')
colnames(gamblingp)=c('TDProp','RemTRs')
colnames(gamblingm1)=c('TDProp','RemTRs')
colnames(gamblingm2)=c('TDProp','RemTRs')

wmbv=data.frame(cbind(wm$V1,wm$V5))
wmp=data.frame(cbind(wm$V2,wm$V6))
wmm1=data.frame(cbind(wm$V3,wm$V7))
wmm2=data.frame(cbind(wm$V4,wm$V8))
colnames(wmbv)=c('TDProp','RemTRs')
colnames(wmp)=c('TDProp','RemTRs')
colnames(wmm1)=c('TDProp','RemTRs')
colnames(wmm2)=c('TDProp','RemTRs')

# get subject IDs from this rds
alff=readRDS('~/OutPlacDrug_alff.rds')
rs1bv$Subjects=alff$SubjID
rs1p$Subjects=alff$SubjID
rs1m1$Subjects=alff$SubjID
rs1m2$Subjects=alff$SubjID

rs2bv$Subjects=alff$SubjID
rs2p$Subjects=alff$SubjID
rs2m1$Subjects=alff$SubjID
rs2m2$Subjects=alff$SubjID

emobv$Subjects=alff$SubjID
emop$Subjects=alff$SubjID
emom1$Subjects=alff$SubjID
emom2$Subjects=alff$SubjID

gamblingbv$Subjects=alff$SubjID
gamblingp$Subjects=alff$SubjID
gamblingm1$Subjects=alff$SubjID
gamblingm2$Subjects=alff$SubjID

wmbv$Subjects=alff$SubjID
wmp$Subjects=alff$SubjID
wmm1$Subjects=alff$SubjID
wmm2$Subjects=alff$SubjID

# add in task (rs to be made equivalent after motion merge)
rs1bv$Task='rs'
rs1p$Task='rs'
rs1m1$Task='rs'
rs1m2$Task='rs'

rs2bv$Task='rs2'
rs2p$Task='rs2'
rs2m1$Task='rs2'
rs2m2$Task='rs2'

emobv$Task='emotion'
emop$Task='emotion'
emom1$Task='emotion'
emom2$Task='emotion'

gamblingbv$Task='gambling'
gamblingp$Task='gambling'
gamblingm1$Task='gambling'
gamblingm2$Task='gambling'

wmbv$Task='wm'
wmp$Task='wm'
wmm1$Task='wm'
wmm2$Task='wm'

# add in dosage
rs1bv$Dosage='baseline'
rs1p$Dosage='Placebo'
rs1m1$Dosage='80mg'
rs1m2$Dosage='120mg'

rs2bv$Dosage='baseline'
rs2p$Dosage='Placebo'
rs2m1$Dosage='80mg'
rs2m2$Dosage='120mg'

emobv$Dosage='baseline'
emop$Dosage='Placebo'
emom1$Dosage='80mg'
emom2$Dosage='120mg'

gamblingbv$Dosage='baseline'
gamblingp$Dosage='Placebo'
gamblingm1$Dosage='80mg'
gamblingm2$Dosage='120mg'

wmbv$Dosage='baseline'
wmp$Dosage='Placebo'
wmm1$Dosage='80mg'
wmm2$Dosage='120mg'

# comibine all
allScans=rbind(rs1bv,rs1p,rs1m1,rs1m2,rs2bv,rs2p,rs2m1,rs2m2,emobv,emop,emom1,emom2,gamblingbv,gamblingp,gamblingm1,gamblingm2,wmbv,wmp,wmm1,wmm2)

# read in motion
mot=read.csv('~/Desktop/MDMA_spikes_summary.csv')

# motion merge
mergedDf=merge(mot,allScans,by=c('Subjects','Task','Dosage'))
mergedDf=mergedDf[mergedDf$Dosage!='baseline',]
mergedDf$Drug=0
mergedDf$Drug[mergedDf$Dosage=="120mg"]=1
mergedDf$Drug[mergedDf$Dosage=="80mg"]=1
mergedDf$Drug=as.factor(mergedDf$Drug)
mergedDfProps=mergedDf
```

```{r}
# remove data that needs to be removed (subs 6 and 10, <250 TRs)
mergedDf=mergedDf[mergedDf$Subjects!='sub-MDMA006',]
mergedDf=mergedDf[mergedDf$Subjects!='sub-MDMA010',]
mergedDf=mergedDf[mergedDf$RemTRs>250,]

# change rs2 to rs for accurate task-modeling
#mergedDf$Task[mergedDf$Task=='rs2']='rs'
mergedDf$Task=as.factor(mergedDf$Task)

# set rs to reference level
mergedDf <- within(mergedDf, Task <- relevel(Task, ref = 2))

# model
model <- lme(TDProp ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDf)

# subset for p-80
df_plot1=mergedDf[mergedDf$Dosage!="120mg",]
# for p-120
df_plot2=mergedDf[mergedDf$Dosage!="80mg",]

ggplot(df_plot1, aes(x = Drug, y = TDProp, fill = Drug)) + geom_violin() +
  geom_point(aes(color = Subjects), size = 5) +
  geom_line(data = df_plot1, aes(group = Subjects,color=Subjects)) +
  geom_point(aes(color = Subjects),data=df_plot2, size = 5) +
  geom_line(data = df_plot2, aes(group = Subjects,color=Subjects)) +
  scale_color_viridis_d(option = "plasma")+
  theme_bw(base_size=22)

summary(model)

# and plot each task separately to gauge samples needed for robust effect
# RS
mergedDfT=mergedDf[mergedDf$Task=='rs',]
# model
model <- lme(TDProp ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDfT)
# subset for p-80
df_plot1=mergedDfT[mergedDfT$Dosage!="120mg",]
# for p-120
df_plot2=mergedDfT[mergedDfT$Dosage!="80mg",]
# plot
ggplot(df_plot1, aes(x = Drug, y = TDProp, fill = Drug)) + geom_violin() +
  geom_point(aes(color = Subjects), size = 5) +
  geom_line(data = df_plot1, aes(group = Subjects,color=Subjects)) +
  geom_point(aes(color = Subjects),data=df_plot2, size = 5) +
  geom_line(data = df_plot2, aes(group = Subjects,color=Subjects)) +
  scale_color_viridis_d(option = "plasma")+
  theme_bw(base_size=22)
# model output
summary(model)

# RS 2
mergedDfT=mergedDf[mergedDf$Task=='rs2',]
# model
model <- lme(TDProp ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDfT)
# subset for p-80
df_plot1=mergedDfT[mergedDfT$Dosage!="120mg",]
# for p-120
df_plot2=mergedDfT[mergedDfT$Dosage!="80mg",]
# plot
ggplot(df_plot1, aes(x = Drug, y = TDProp, fill = Drug)) + geom_violin() +
  geom_point(aes(color = Subjects), size = 5) +
  geom_line(data = df_plot1, aes(group = Subjects,color=Subjects)) +
  geom_point(aes(color = Subjects),data=df_plot2, size = 5) +
  geom_line(data = df_plot2, aes(group = Subjects,color=Subjects)) +
  scale_color_viridis_d(option = "plasma")+
  theme_bw(base_size=22)
# model output
summary(model)

# WM
mergedDfT=mergedDf[mergedDf$Task=='wm',]
# model
model <- lme(TDProp ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDfT)
# subset for p-80
df_plot1=mergedDfT[mergedDfT$Dosage!="120mg",]
# for p-120
df_plot2=mergedDfT[mergedDfT$Dosage!="80mg",]
# plot
ggplot(df_plot1, aes(x = Drug, y = TDProp, fill = Drug)) + geom_violin() +
  geom_point(aes(color = Subjects), size = 5) +
  geom_line(data = df_plot1, aes(group = Subjects,color=Subjects)) +
  geom_point(aes(color = Subjects),data=df_plot2, size = 5) +
  geom_line(data = df_plot2, aes(group = Subjects,color=Subjects)) +
  scale_color_viridis_d(option = "plasma")+
  theme_bw(base_size=22)
# model output
summary(model)

# gambling
mergedDfT=mergedDf[mergedDf$Task=='gambling',]
# model
model <- lme(TDProp ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDfT)
# subset for p-80
df_plot1=mergedDfT[mergedDfT$Dosage!="120mg",]
# for p-120
df_plot2=mergedDfT[mergedDfT$Dosage!="80mg",]
# plot
ggplot(df_plot1, aes(x = Drug, y = TDProp, fill = Drug)) + geom_violin() +
  geom_point(aes(color = Subjects), size = 5) +
  geom_line(data = df_plot1, aes(group = Subjects,color=Subjects)) +
  geom_point(aes(color = Subjects),data=df_plot2, size = 5) +
  geom_line(data = df_plot2, aes(group = Subjects,color=Subjects)) +
  scale_color_viridis_d(option = "plasma")+
  theme_bw(base_size=22)
# model output
summary(model)

```

```{r}
# complexity
rs1=read.csv('~/Downloads/P50 MDMA/rs1_complexityMerged.csv',header=F)
rs2=read.csv('~/Downloads/P50 MDMA/rs2_complexityMerged.csv',header=F)
emo=read.csv('~/Downloads/P50 MDMA/emotion_complexityMerged.csv',header=F)
gambling=read.csv('~/Downloads/P50 MDMA/gambling_complexityMerged.csv',header=F)
wm=read.csv('~/Downloads/P50 MDMA/wm_complexityMerged.csv',header=F)
# set colnames
#colnames(rs1)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(rs2)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(emo)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(gambling)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(wm)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
rs1$Task='rs'
rs2$Task='rs2'
emo$Task='emotion'
gambling$Task='gambling'
wm$Task='wm'

# remove subj 4
rs1=rs1[-c(4),]
rs2=rs2[-c(4),]
emo=emo[-c(4),]
gambling=gambling[-c(4),]
wm=wm[-c(4),]

# this is going to be ugly but simple
# manually pair columns as sep. observations of baseline, placebo, 80, 120mg
rs1bv=data.frame(cbind(rs1$V1,rs1$V5))
rs1p=data.frame(cbind(rs1$V2,rs1$V6))
rs1m1=data.frame(cbind(rs1$V3,rs1$V7))
rs1m2=data.frame(cbind(rs1$V4,rs1$V8))
colnames(rs1bv)=c('Complexity','RemTRs')
colnames(rs1p)=c('Complexity','RemTRs')
colnames(rs1m1)=c('Complexity','RemTRs')
colnames(rs1m2)=c('Complexity','RemTRs')

rs2bv=data.frame(cbind(rs2$V1,rs2$V5))
rs2p=data.frame(cbind(rs2$V2,rs2$V6))
rs2m1=data.frame(cbind(rs2$V3,rs2$V7))
rs2m2=data.frame(cbind(rs2$V4,rs2$V8))
colnames(rs2bv)=c('Complexity','RemTRs')
colnames(rs2p)=c('Complexity','RemTRs')
colnames(rs2m1)=c('Complexity','RemTRs')
colnames(rs2m2)=c('Complexity','RemTRs')

emobv=data.frame(cbind(emo$V1,emo$V5))
emop=data.frame(cbind(emo$V2,emo$V6))
emom1=data.frame(cbind(emo$V3,emo$V7))
emom2=data.frame(cbind(emo$V4,emo$V8))
colnames(emobv)=c('Complexity','RemTRs')
colnames(emop)=c('Complexity','RemTRs')
colnames(emom1)=c('Complexity','RemTRs')
colnames(emom2)=c('Complexity','RemTRs')

gamblingbv=data.frame(cbind(gambling$V1,gambling$V5))
gamblingp=data.frame(cbind(gambling$V2,gambling$V6))
gamblingm1=data.frame(cbind(gambling$V3,gambling$V7))
gamblingm2=data.frame(cbind(gambling$V4,gambling$V8))
colnames(gamblingbv)=c('Complexity','RemTRs')
colnames(gamblingp)=c('Complexity','RemTRs')
colnames(gamblingm1)=c('Complexity','RemTRs')
colnames(gamblingm2)=c('Complexity','RemTRs')

wmbv=data.frame(cbind(wm$V1,wm$V5))
wmp=data.frame(cbind(wm$V2,wm$V6))
wmm1=data.frame(cbind(wm$V3,wm$V7))
wmm2=data.frame(cbind(wm$V4,wm$V8))
colnames(wmbv)=c('Complexity','RemTRs')
colnames(wmp)=c('Complexity','RemTRs')
colnames(wmm1)=c('Complexity','RemTRs')
colnames(wmm2)=c('Complexity','RemTRs')

# get subject IDs from this rds
alff=readRDS('~/OutPlacDrug_alff.rds')
rs1bv$Subjects=alff$SubjID
rs1p$Subjects=alff$SubjID
rs1m1$Subjects=alff$SubjID
rs1m2$Subjects=alff$SubjID

rs2bv$Subjects=alff$SubjID
rs2p$Subjects=alff$SubjID
rs2m1$Subjects=alff$SubjID
rs2m2$Subjects=alff$SubjID

emobv$Subjects=alff$SubjID
emop$Subjects=alff$SubjID
emom1$Subjects=alff$SubjID
emom2$Subjects=alff$SubjID

gamblingbv$Subjects=alff$SubjID
gamblingp$Subjects=alff$SubjID
gamblingm1$Subjects=alff$SubjID
gamblingm2$Subjects=alff$SubjID

wmbv$Subjects=alff$SubjID
wmp$Subjects=alff$SubjID
wmm1$Subjects=alff$SubjID
wmm2$Subjects=alff$SubjID

# add in task (rs to be made equivalent after motion merge)
rs1bv$Task='rs'
rs1p$Task='rs'
rs1m1$Task='rs'
rs1m2$Task='rs'

rs2bv$Task='rs2'
rs2p$Task='rs2'
rs2m1$Task='rs2'
rs2m2$Task='rs2'

emobv$Task='emotion'
emop$Task='emotion'
emom1$Task='emotion'
emom2$Task='emotion'

gamblingbv$Task='gambling'
gamblingp$Task='gambling'
gamblingm1$Task='gambling'
gamblingm2$Task='gambling'

wmbv$Task='wm'
wmp$Task='wm'
wmm1$Task='wm'
wmm2$Task='wm'

# add in dosage
rs1bv$Dosage='baseline'
rs1p$Dosage='Placebo'
rs1m1$Dosage='80mg'
rs1m2$Dosage='120mg'

rs2bv$Dosage='baseline'
rs2p$Dosage='Placebo'
rs2m1$Dosage='80mg'
rs2m2$Dosage='120mg'

emobv$Dosage='baseline'
emop$Dosage='Placebo'
emom1$Dosage='80mg'
emom2$Dosage='120mg'

gamblingbv$Dosage='baseline'
gamblingp$Dosage='Placebo'
gamblingm1$Dosage='80mg'
gamblingm2$Dosage='120mg'

wmbv$Dosage='baseline'
wmp$Dosage='Placebo'
wmm1$Dosage='80mg'
wmm2$Dosage='120mg'

# comibine all
allScans=rbind(rs1bv,rs1p,rs1m1,rs1m2,rs2bv,rs2p,rs2m1,rs2m2,emobv,emop,emom1,emom2,gamblingbv,gamblingp,gamblingm1,gamblingm2,wmbv,wmp,wmm1,wmm2)

# read in motion
mot=read.csv('~/Desktop/MDMA_spikes_summary.csv')

# motion merge
mergedDf=merge(mot,allScans,by=c('Subjects','Task','Dosage'))
mergedDf=mergedDf[mergedDf$Dosage!='baseline',]
mergedDf$Drug=0
mergedDf$Drug[mergedDf$Dosage=="120mg"]=1
mergedDf$Drug[mergedDf$Dosage=="80mg"]=1
mergedDf$Drug=as.factor(mergedDf$Drug)

```

```{r}
# combine complexity and props
mergedDfPropsCompl=merge(mergedDfProps,mergedDf,by=c("Subjects","Task","Dosage","Session","MeanFD","SpikesPercent","RemTRs","Drug"))
```

```{r}
# remove data that needs to be removed (subs 6 and 10, <250 TRs)
mergedDfPropsCompl=mergedDfPropsCompl[mergedDfPropsCompl$Subjects!='sub-MDMA006',]
mergedDfPropsCompl=mergedDfPropsCompl[mergedDfPropsCompl$Subjects!='sub-MDMA010',]
mergedDfPropsCompl=mergedDfPropsCompl[mergedDfPropsCompl$RemTRs>250,]

# change rs2 to rs for accurate task-modeling
mergedDfPropsCompl$Task[mergedDfPropsCompl$Task=='rs2']='rs'
mergedDfPropsCompl$Task=as.factor(mergedDfPropsCompl$Task)

# set rs to reference level
mergedDfPropsCompl <- within(mergedDfPropsCompl, Task <- relevel(Task, ref = 2))

# model
model <- lme(TDProp ~ MeanFD + Drug, random = ~ 1 | Subjects, data = mergedDfPropsCompl)
```

```{r}
library(sjPlot)
# visualize
sjPlot::plot_model(model, type = "eff",show.values = T)
sjPlot::plot_model(model, type = "int")

# summarize
summary(model)

# Summarize the model
model_summary <- summary(model)


library(ggridges)

# Extract fitted values and residuals
fitted_values <- fitted(model)
residuals <- resid(model)

# Combine fitted values and residuals with the original data
plot_data <- cbind(mergedDf, Fitted = fitted_values, Residuals = residuals)

# Create a raincloud plot
ggplot(mergedDf2, aes(x = Drug, y = TDProp, fill = Task)) +
  geom_point(aes(color = Task), position = position_jitter(width = 0.2), size = 2) +
  geom_boxplot(width = 0.2, fill = "white", color = "black", outlier.shape = NA) +
  labs(title = "Fitted Values and Residuals",
       y = "TDProp",
       color = "Task") +
  theme_minimal() +
  theme(legend.position = "top")


# Create a ggplot with points, fitted values, and residuals

```

```{r}
# now compare with VAS
```


```{r}
test=masterdf
test$Drug=0
test$Drug[test$Dosage=="120mg"]=1
test$Drug[test$Dosage=="80mg"]=1
test$Drug<-as.factor(test$Drug)


# filter out subjs with low data volume
test <- test %>%
  filter(Subjects != 'sub-MDMA006')

test <- test %>%
  filter(Subjects != 'sub-MDMA010')


model <- lme(TDProp ~ MeanFD + Drug + Task+Task*Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDf)
# testing for brain-brain assoc
model <- lme(alff ~ value + Average_MeanFD , random = ~ 1 | Subjects, data = test)
# and alff independently
model <- lme(alff ~ value + Average_MeanFD , random = ~ 1 | Subjects, data = test)


testV=merge(vas,test,by=c("Subjects","Dosage"))

# initialize correlation vector for vas
corvec=NULL
pvec=NULL
colNameVec=NULL
for (i in 3:39){
  print(colnames(testV)[i])
  print(cor.test(testV$value,testV[,i]))
  corvec[i-2]=cor.test(testV$value,testV[,i])$estimate
  pvec[i-2]=cor.test(testV$value,testV[,i])$p.value
  colNameVec[i-2]=colnames(testV)[i]
}

# Create a dataframe with the values and column names
df <- data.frame(Values = corvec, ColumnNames = colNameVec)

# make a positive vs. negative colorvec
df$colorvec=rep(0,37)
df$colorvec[c(3,8,11,15,18,19,22,23,24,29,31,34,35,36)]=1

# Make a positive vs. negative color vector
df$colorvec <- ifelse(df$colorvec < 1, "Positive", "Negative")

# and make a VAS categorization equivalent to the one Lea sent
df$VasCat=c('SocialApp','SocialApp','Drug','Empathy','PosAff','Sociable','Prosocial','SocialApp','Sociable','SocialApp','NegAff','Sociable','Temperament','Prosocial','NegAff','Sociable','Sociable','NegAff','NegAff','PosAff','Temperament','Temperament','Cognitive','NegAff','Cognitive','Prosocial','Empathy','Cognitive','Sociable','Cognitive','NegAff','Drug','Drug','Drug','Drug','No Label','No Label')
# set inverse scores
df$VasCatInv=0
df$VasCatInv[df$ColumnNames=='vas_ego_post_pre']=1
df$VasCatInv[df$ColumnNames=='vas_bewilderment_post_pre']=1
df$VasCatInv[df$ColumnNames=='vas_lonesome_post_pre']=1
df$VasCatInv[df$ColumnNames=='vas_defensiveness_post_pre']=1
df$VasCatInv=as.factor(df$VasCatInv)
# Order the ColumnNames as an ordered factor based on the Values
df$ColumnNames <- factor(df$ColumnNames, levels = df$ColumnNames[order(df$Values, decreasing = FALSE)])

# Create the plot using ggplot
ggplot(df, aes(x = Values, y = ColumnNames, color = colorvec)) +
  geom_point(size=3) +
  xlim(-0.6, 0.6) +
  labs(x = "Values", y = "Column Names", title = "Correlation Plot")+theme_minimal()

# box and whiskers version
# Create box and whisker plots
ggplot(df, aes(x = colorvec, y = Values, fill = colorvec)) +
  geom_boxplot(outlier.size=3) +
  labs(x = "", y = "Correlation with DMN Out-flow") +
  theme_bw(base_size=30)+guides(fill=FALSE)
# with more granular categories
ggplot(df, aes(x = VasCat, y = Values, fill = VasCat)) +
  geom_boxplot(outlier.size=3) +
  labs(x = "", y = "Correlation with DMN Out-flow") +
  theme_bw(base_size=25)+guides(fill=FALSE)+
  geom_point(aes(y=Values,color=VasCatInv),size=3)+
  labs(color = "Reverse Scored")

# head motion
ggplot(test, aes(x = Dosage, y= Average_MeanFD)) +
  geom_boxplot() +
  ylab("Average_MeanFD") +
  xlab("Dosage") +theme_minimal(base_size=30)


### what are the chances that pos and neg come out this separated?
# retrieve true t-stat
pos=df[df$colorvec=='Positive',]
neg=df[df$colorvec=='Negative',]
trueT=t.test(pos$Values,neg$Values,paired=F)$statistic
# initialiaze null t vector
nullT=NULL
# run 1000 permutaitons and check it out - permute session and subject labels
for (perm in 1:10000){
  print(perm)
  # permute data
  permV=testV
  permV$value=sample(permV$value)
  corvec=NULL
  pvec=NULL
  colNameVec=NULL
  for (i in 3:39){
    corvec[i-2]=cor.test(permV$value,permV[,i])$estimate
  }
  # Create a dataframe with the values and column names
  pdf <- data.frame(Values = corvec)
  # make a positive vs. negative vector
  pdf$posnegvec=rep(0,37)
  pdf$posnegvec[c(3,8,11,15,18,19,22,23,24,29,31,34,35,36)]=1
  pdf$posnegvec <- ifelse(pdf$posnegvec < 1, "Positive", "Negative")
  # separate out pos and neg for t.test
  ppos=pdf[pdf$posnegvec=='Positive',]
  pneg=pdf[pdf$posnegvec=='Negative',]
  nullT[perm]=t.test(ppos$Values,pneg$Values,paired=F)$statistic
}
# make plotdf
plotdf=data.frame(nullT)
# plot
ggplot(plotdf,aes(x=nullT))+geom_density(size=1.5)+geom_vline(xintercept = trueT,size=2,color='#BC3754')+theme_classic(base_size=23)+ylab('')+xlab('T-Statistics')+guides(y="none")+theme(axis.text = element_text(size=22))

```

```{r}
library(ggplot2)

test$Group=0
test$Group[test$Subjects=='sub-MDMA005']=1
test$Group[test$Subjects=='sub-MDMA007']=1
test$Group[test$Subjects=='sub-MDMA009']=1
test$Group[test$Subjects=='sub-MDMA011']=1
test$Group[test$Subjects=='sub-MDMA014']=1
test$Group[test$Subjects=='sub-MDMA015']=1
test$Group[test$Subjects=='sub-MDMA017']=1
test$Group[test$Subjects=='sub-MDMA003']=1
test$Group[test$Subjects=='sub-MDMA008']=1


# Create a reduced model without controlling for the relationship between "value" and "Drug"
full_model <- lme(value ~ Average_MeanFD + Drug+Group+Drug*Group, random = ~ 1 | Subjects, data = test)

reduced_model <- lme(value ~ Average_MeanFD, random = ~ 1 | Subjects, data = test)

# Compute the residuals based on the reduced model
df_plot <- data.frame(
  Subjects = test$Subjects,
  Residuals = residuals(reduced_model),
  DMNFlow = test$value, 
  Drug = test$Drug,
  Dose = test$Dosage,
  Alff = test$alff,
  Reactivity = test$Group,
  Average_MeanFD = test$Average_MeanFD)

# subset for p-80
df_plot1=df_plot[df_plot$Dose!="120mg",]
# for p-120
df_plot2=df_plot[df_plot$Dose!="80mg",]

test120=test[test$Dosage!="80mg",]
test120=test120[test120$Dosage!="baseline",]

placeboVsFull <- lme(value ~ Average_MeanFD + Drug*Group, random = ~ 1 | Subjects, data = test120)

# Create the fixed effects plot
ggplot(df_plot1, aes(x = Drug, y = Residuals, fill = Drug)) +
  geom_point(aes(color = Subjects), size = 5) +
  geom_line(data = df_plot1, aes(group = Subjects,color=Subjects)) +
  geom_point(aes(color = Subjects),data=df_plot2, size = 5) +
  geom_line(data = df_plot2, aes(group = Subjects,color=Subjects)) +
  scale_color_viridis_d(option = "plasma")+
  theme_bw(base_size=22)

ggplot(df_plot1, aes(x = Drug, y = DMNFlow, fill = Drug)) +
  geom_point(aes(color = Subjects), size = 5) +
  geom_line(data = df_plot1, aes(group = Subjects,color=Subjects)) +
  geom_point(aes(color = Subjects),data=df_plot2, size = 5) +
  geom_line(data = df_plot2, aes(group = Subjects,color=Subjects)) +
  scale_color_viridis_d(option = "plasma")+
  theme_bw(base_size=22)+ylab('DMN Out-flow')

# load in vas
els=read.csv('~/Downloads/MDMA_Questionnaires_baseline.csv')
# correct subject naming
els$Subjects <- paste0("sub-MDMA", sprintf("%03d", els$Subjects))
testV=merge(els,test,by=c("Subjects"))

```


```{r}
# Amyg DMN Fc
rs1=read.csv('~/Downloads/P50 MDMA/rs1_DMN_AmygFC_Merged.csv',header=F)
rs2=read.csv('~/Downloads/P50 MDMA/rs2_DMN_AmygFC_Merged.csv',header=F)
emo=read.csv('~/Downloads/P50 MDMA/emotion_DMN_AmygFC_Merged.csv',header=F)
gambling=read.csv('~/Downloads/P50 MDMA/gambling_DMN_AmygFC_Merged.csv',header=F)
wm=read.csv('~/Downloads/P50 MDMA/wm_DMN_AmygFC_Merged.csv',header=F)
noncon=read.csv('~/Downloads/P50 MDMA/nonconscious_DMN_AmygFC_Merged.csv',header=F)
con=read.csv('~/Downloads/P50 MDMA/conscious_DMN_AmygFC_Merged.csv',header=F)
gng=read.csv('~/Downloads/P50 MDMA/gonogo_DMN_AmygFC_Merged.csv',header=F)
# set colnames
#colnames(rs1)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(rs2)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(emo)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(gambling)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(wm)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
rs1$Task='rs'
rs2$Task='rs2'
emo$Task='emotion'
gambling$Task='gambling'
wm$Task='wm'
noncon$Task='nonconscious'
con$Task='conscious'
gng$Task='gonogo'

# remove subj 4
rs1=rs1[-c(4),]
rs2=rs2[-c(4),]
emo=emo[-c(4),]
gambling=gambling[-c(4),]
wm=wm[-c(4),]
noncon=noncon[-c(4),]
con=con[-c(4),]
gng=gng[-c(4),]

# this is going to be ugly but simple
# manually pair columns as sep. observations of baseline, placebo, 80, 120mg
rs1bv=data.frame(cbind(rs1$V1,rs1$V5))
rs1p=data.frame(cbind(rs1$V2,rs1$V6))
rs1m1=data.frame(cbind(rs1$V3,rs1$V7))
rs1m2=data.frame(cbind(rs1$V4,rs1$V8))
colnames(rs1bv)=c('TDProp','RemTRs')
colnames(rs1p)=c('TDProp','RemTRs')
colnames(rs1m1)=c('TDProp','RemTRs')
colnames(rs1m2)=c('TDProp','RemTRs')

rs2bv=data.frame(cbind(rs2$V1,rs2$V5))
rs2p=data.frame(cbind(rs2$V2,rs2$V6))
rs2m1=data.frame(cbind(rs2$V3,rs2$V7))
rs2m2=data.frame(cbind(rs2$V4,rs2$V8))
colnames(rs2bv)=c('TDProp','RemTRs')
colnames(rs2p)=c('TDProp','RemTRs')
colnames(rs2m1)=c('TDProp','RemTRs')
colnames(rs2m2)=c('TDProp','RemTRs')

emobv=data.frame(cbind(emo$V1,emo$V5))
emop=data.frame(cbind(emo$V2,emo$V6))
emom1=data.frame(cbind(emo$V3,emo$V7))
emom2=data.frame(cbind(emo$V4,emo$V8))
colnames(emobv)=c('TDProp','RemTRs')
colnames(emop)=c('TDProp','RemTRs')
colnames(emom1)=c('TDProp','RemTRs')
colnames(emom2)=c('TDProp','RemTRs')

gamblingbv=data.frame(cbind(gambling$V1,gambling$V5))
gamblingp=data.frame(cbind(gambling$V2,gambling$V6))
gamblingm1=data.frame(cbind(gambling$V3,gambling$V7))
gamblingm2=data.frame(cbind(gambling$V4,gambling$V8))
colnames(gamblingbv)=c('TDProp','RemTRs')
colnames(gamblingp)=c('TDProp','RemTRs')
colnames(gamblingm1)=c('TDProp','RemTRs')
colnames(gamblingm2)=c('TDProp','RemTRs')

wmbv=data.frame(cbind(wm$V1,wm$V5))
wmp=data.frame(cbind(wm$V2,wm$V6))
wmm1=data.frame(cbind(wm$V3,wm$V7))
wmm2=data.frame(cbind(wm$V4,wm$V8))
colnames(wmbv)=c('TDProp','RemTRs')
colnames(wmp)=c('TDProp','RemTRs')
colnames(wmm1)=c('TDProp','RemTRs')
colnames(wmm2)=c('TDProp','RemTRs')

nonconbv=data.frame(cbind(noncon$V1,noncon$V5))
nonconp=data.frame(cbind(noncon$V2,noncon$V6))
nonconm1=data.frame(cbind(noncon$V3,noncon$V7))
nonconm2=data.frame(cbind(noncon$V4,noncon$V8))
colnames(nonconbv)=c('TDProp','RemTRs')
colnames(nonconp)=c('TDProp','RemTRs')
colnames(nonconm1)=c('TDProp','RemTRs')
colnames(nonconm2)=c('TDProp','RemTRs')

conbv=data.frame(cbind(con$V1,con$V5))
conp=data.frame(cbind(con$V2,con$V6))
conm1=data.frame(cbind(con$V3,con$V7))
conm2=data.frame(cbind(con$V4,con$V8))
colnames(conbv)=c('TDProp','RemTRs')
colnames(conp)=c('TDProp','RemTRs')
colnames(conm1)=c('TDProp','RemTRs')
colnames(conm2)=c('TDProp','RemTRs')

gngbv=data.frame(cbind(gng$V1,gng$V5))
gngp=data.frame(cbind(gng$V2,gng$V6))
gngm1=data.frame(cbind(gng$V3,gng$V7))
gngm2=data.frame(cbind(gng$V4,gng$V8))
colnames(gngbv)=c('TDProp','RemTRs')
colnames(gngp)=c('TDProp','RemTRs')
colnames(gngm1)=c('TDProp','RemTRs')
colnames(gngm2)=c('TDProp','RemTRs')

# get subject IDs from this rds
alff=readRDS('~/OutPlacDrug_alff.rds')
rs1bv$Subjects=alff$SubjID
rs1p$Subjects=alff$SubjID
rs1m1$Subjects=alff$SubjID
rs1m2$Subjects=alff$SubjID

rs2bv$Subjects=alff$SubjID
rs2p$Subjects=alff$SubjID
rs2m1$Subjects=alff$SubjID
rs2m2$Subjects=alff$SubjID

emobv$Subjects=alff$SubjID
emop$Subjects=alff$SubjID
emom1$Subjects=alff$SubjID
emom2$Subjects=alff$SubjID

gamblingbv$Subjects=alff$SubjID
gamblingp$Subjects=alff$SubjID
gamblingm1$Subjects=alff$SubjID
gamblingm2$Subjects=alff$SubjID

wmbv$Subjects=alff$SubjID
wmp$Subjects=alff$SubjID
wmm1$Subjects=alff$SubjID
wmm2$Subjects=alff$SubjID

nonconbv$Subjects=alff$SubjID
nonconp$Subjects=alff$SubjID
nonconm1$Subjects=alff$SubjID
nonconm2$Subjects=alff$SubjID

conbv$Subjects=alff$SubjID
conp$Subjects=alff$SubjID
conm1$Subjects=alff$SubjID
conm2$Subjects=alff$SubjID

gngbv$Subjects=alff$SubjID
gngp$Subjects=alff$SubjID
gngm1$Subjects=alff$SubjID
gngm2$Subjects=alff$SubjID

# add in task (rs to be made equivalent after motion merge)
rs1bv$Task='rs'
rs1p$Task='rs'
rs1m1$Task='rs'
rs1m2$Task='rs'

rs2bv$Task='rs2'
rs2p$Task='rs2'
rs2m1$Task='rs2'
rs2m2$Task='rs2'

emobv$Task='emotion'
emop$Task='emotion'
emom1$Task='emotion'
emom2$Task='emotion'

gamblingbv$Task='gambling'
gamblingp$Task='gambling'
gamblingm1$Task='gambling'
gamblingm2$Task='gambling'

wmbv$Task='wm'
wmp$Task='wm'
wmm1$Task='wm'
wmm2$Task='wm'

nonconbv$Task='nonconscious'
nonconp$Task='nonconscious'
nonconm1$Task='nonconscious'
nonconm2$Task='nonconscious'

conbv$Task='conscious'
conp$Task='conscious'
conm1$Task='conscious'
conm2$Task='conscious'

gngbv$Task='gonogo'
gngp$Task='gonogo'
gngm1$Task='gonogo'
gngm2$Task='gonogo'

# add in dosage
rs1bv$Dosage='baseline'
rs1p$Dosage='Placebo'
rs1m1$Dosage='80mg'
rs1m2$Dosage='120mg'

rs2bv$Dosage='baseline'
rs2p$Dosage='Placebo'
rs2m1$Dosage='80mg'
rs2m2$Dosage='120mg'

emobv$Dosage='baseline'
emop$Dosage='Placebo'
emom1$Dosage='80mg'
emom2$Dosage='120mg'

gamblingbv$Dosage='baseline'
gamblingp$Dosage='Placebo'
gamblingm1$Dosage='80mg'
gamblingm2$Dosage='120mg'

wmbv$Dosage='baseline'
wmp$Dosage='Placebo'
wmm1$Dosage='80mg'
wmm2$Dosage='120mg'

nonconbv$Dosage='baseline'
nonconp$Dosage='Placebo'
nonconm1$Dosage='80mg'
nonconm2$Dosage='120mg'

conbv$Dosage='baseline'
conp$Dosage='Placebo'
conm1$Dosage='80mg'
conm2$Dosage='120mg'

gngbv$Dosage='baseline'
gngp$Dosage='Placebo'
gngm1$Dosage='80mg'
gngm2$Dosage='120mg'

# combine all
allScans=rbind(rs1bv,rs1p,rs1m1,rs1m2,rs2bv,rs2p,rs2m1,rs2m2,emobv,emop,emom1,emom2,gamblingbv,gamblingp,gamblingm1,gamblingm2,wmbv,wmp,wmm1,wmm2,nonconbv,nonconp,nonconm1,nonconm2,conbv,conp,conm1,conm2,gngbv,gngp,gngm1,gngm2)

# read in motion
mot=read.csv('~/Desktop/MDMA_spikes_summary.csv')

# motion merge
mergedDf=merge(mot,allScans,by=c('Subjects','Task','Dosage'))
mergedDf$Drug=0
mergedDf$Drug[mergedDf$Dosage=="120mg"]=1
mergedDf$Drug[mergedDf$Dosage=="80mg"]=1
mergedDf$Drug=as.factor(mergedDf$Drug)
mergedDfFC=mergedDf

# code rs as one task
mergedDfFC$Task[mergedDfFC$Task=='rs1']='rs'
mergedDfFC$Task[mergedDfFC$Task=='rs2']='rs'
# set rs to reference
mergedDfFC$Task<-as.factor(mergedDfFC$Task)
mergedDfFC$Task <- relevel(mergedDfFC$Task, ref = "rs")
# remove >.3 fd
mergedDfFC=mergedDfFC[mergedDfFC$MeanFD<.3,]
```

```{r}
# test if amyg DMN FC changes after dose
# group by time interaction
# group 1 is placebo second visit
# group 2 is placebo after second visit
# expecting FC to go down with time in second group
# manually delineate groups
mergedDfFC$Group=1
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA002']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA004']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA008']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA009']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA011']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA015']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA017']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA005']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA006']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA007']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA010']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA014']=2
mergedDfFC$Group=as.factor(mergedDfFC$Group)
# PTs to eliminate for consistency (4 already excluded)
mergedDfFC=mergedDfFC[mergedDfFC$Subjects!='sub-MDMA006',]
mergedDfFC=mergedDfFC[mergedDfFC$Subjects!='sub-MDMA010',]
# eliminate drug visits
mergedDfFC_sob=mergedDfFC[mergedDfFC$Drug==0,]
# get change 
# make name accurate
mergedDfFC_sob$AmyFC=mergedDfFC_sob$TDProp


model <- lme(AmyFC ~ MeanFD +Task+ Group*Dosage,random = ~ 1 | Subjects,data = mergedDfFC_sob)

sjPlot::plot_model(model, type = "eff",show.values = T)
sjPlot::plot_model(model, type = "int")
```
