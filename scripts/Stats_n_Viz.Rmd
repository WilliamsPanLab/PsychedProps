---
title: "p50"
output:
  html_document: default
  pdf_document: default
date: "2023-07-13"
---

```{r}
library(reshape2)
library(ggplot2)
library(visreg)
```

```{r}
# prop angles
rs1=read.csv('~/Downloads/P50 MDMA/rs1_propsMerged.csv',header=F)
rs2=read.csv('~/Downloads/P50 MDMA/rs2_propsMerged.csv',header=F)
emo=read.csv('~/Downloads/P50 MDMA/emotion_propsMerged.csv',header=F)
gambling=read.csv('~/Downloads/P50 MDMA/gambling_propsMerged.csv',header=F)
wm=read.csv('~/Downloads/P50 MDMA/wm_propsMerged.csv',header=F)
# set colnames
#colnames(rs1)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(rs2)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(emo)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(gambling)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(wm)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
rs1$Task='rs'
rs2$Task='rs2'
emo$Task='emotion'
gambling$Task='gambling'
wm$Task='wm'

# remove subj 4
rs1=rs1[-c(4),]
rs2=rs2[-c(4),]
emo=emo[-c(4),]
gambling=gambling[-c(4),]
wm=wm[-c(4),]

# this is going to be ugly but simple
# manually pair columns as sep. observations of baseline, placebo, 80, 120mg
rs1bv=data.frame(cbind(rs1$V1,rs1$V2,rs1$V3,rs1$V4,rs1$V17))
rs1p=data.frame(cbind(rs1$V5,rs1$V6,rs1$V7,rs1$V8,rs1$V18))
rs1m1=data.frame(cbind(rs1$V9,rs1$V10,rs1$V11,rs1$V12,rs1$V19))
rs1m2=data.frame(cbind(rs1$V13,rs1$V14,rs1$V15,rs1$V16,rs1$V20))
colnames(rs1bv)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(rs1p)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(rs1m1)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(rs1m2)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')

rs2bv=data.frame(cbind(rs2$V1,rs2$V2,rs2$V3,rs2$V4,rs2$V17))
rs2p=data.frame(cbind(rs2$V5,rs2$V6,rs2$V7,rs2$V8,rs2$V18))
rs2m1=data.frame(cbind(rs2$V9,rs2$V10,rs2$V11,rs2$V12,rs2$V19))
rs2m2=data.frame(cbind(rs2$V13,rs2$V14,rs2$V15,rs2$V16,rs2$V20))
colnames(rs2bv)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(rs2p)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(rs2m1)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(rs2m2)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')

emobv=data.frame(cbind(emo$V1,emo$V2,emo$V3,emo$V4,emo$V17))
emop=data.frame(cbind(emo$V5,emo$V6,emo$V7,emo$V8,emo$V18))
emom1=data.frame(cbind(emo$V9,emo$V10,emo$V11,emo$V12,emo$V19))
emom2=data.frame(cbind(emo$V13,emo$V14,emo$V15,emo$V16,emo$V20))
colnames(emobv)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(emop)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(emom1)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(emom2)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')

gamblingbv=data.frame(cbind(gambling$V1,gambling$V2,gambling$V3,gambling$V4,gambling$V17))
gamblingp=data.frame(cbind(gambling$V5,gambling$V6,gambling$V7,gambling$V8,gambling$V18))
gamblingm1=data.frame(cbind(gambling$V9,gambling$V10,gambling$V11,gambling$V12,gambling$V19))
gamblingm2=data.frame(cbind(gambling$V13,gambling$V14,gambling$V15,gambling$V16,gambling$V20))
colnames(gamblingbv)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(gamblingp)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(gamblingm1)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(gamblingm2)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')

wmbv=data.frame(cbind(wm$V1,wm$V2,wm$V3,wm$V4,wm$V17))
wmp=data.frame(cbind(wm$V5,wm$V6,wm$V7,wm$V8,wm$V18))
wmm1=data.frame(cbind(wm$V9,wm$V10,wm$V11,wm$V12,wm$V19))
wmm2=data.frame(cbind(wm$V13,wm$V14,wm$V15,wm$V16,wm$V20))
colnames(wmbv)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(wmp)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(wmm1)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')
colnames(wmm2)=c('TDProp1','TDProp2','TDProp3','TDProp4','RemTRs')

# get subject IDs from this rds
alff=readRDS('~/OutPlacDrug_alff.rds')
rs1bv$Subjects=alff$SubjID
rs1p$Subjects=alff$SubjID
rs1m1$Subjects=alff$SubjID
rs1m2$Subjects=alff$SubjID

rs2bv$Subjects=alff$SubjID
rs2p$Subjects=alff$SubjID
rs2m1$Subjects=alff$SubjID
rs2m2$Subjects=alff$SubjID

emobv$Subjects=alff$SubjID
emop$Subjects=alff$SubjID
emom1$Subjects=alff$SubjID
emom2$Subjects=alff$SubjID

gamblingbv$Subjects=alff$SubjID
gamblingp$Subjects=alff$SubjID
gamblingm1$Subjects=alff$SubjID
gamblingm2$Subjects=alff$SubjID

wmbv$Subjects=alff$SubjID
wmp$Subjects=alff$SubjID
wmm1$Subjects=alff$SubjID
wmm2$Subjects=alff$SubjID

# add in task (rs to be made equivalent after motion merge)
rs1bv$Task='rs'
rs1p$Task='rs'
rs1m1$Task='rs'
rs1m2$Task='rs'

rs2bv$Task='rs2'
rs2p$Task='rs2'
rs2m1$Task='rs2'
rs2m2$Task='rs2'

emobv$Task='emotion'
emop$Task='emotion'
emom1$Task='emotion'
emom2$Task='emotion'

gamblingbv$Task='gambling'
gamblingp$Task='gambling'
gamblingm1$Task='gambling'
gamblingm2$Task='gambling'

wmbv$Task='wm'
wmp$Task='wm'
wmm1$Task='wm'
wmm2$Task='wm'

# add in dosage
rs1bv$Dosage='baseline'
rs1p$Dosage='Placebo'
rs1m1$Dosage='80mg'
rs1m2$Dosage='120mg'

rs2bv$Dosage='baseline'
rs2p$Dosage='Placebo'
rs2m1$Dosage='80mg'
rs2m2$Dosage='120mg'

emobv$Dosage='baseline'
emop$Dosage='Placebo'
emom1$Dosage='80mg'
emom2$Dosage='120mg'

gamblingbv$Dosage='baseline'
gamblingp$Dosage='Placebo'
gamblingm1$Dosage='80mg'
gamblingm2$Dosage='120mg'

wmbv$Dosage='baseline'
wmp$Dosage='Placebo'
wmm1$Dosage='80mg'
wmm2$Dosage='120mg'

# comibine all
allScans=rbind(rs1bv,rs1p,rs1m1,rs1m2,rs2bv,rs2p,rs2m1,rs2m2,emobv,emop,emom1,emom2,gamblingbv,gamblingp,gamblingm1,gamblingm2,wmbv,wmp,wmm1,wmm2)

# read in motion
mot=read.csv('~/Desktop/MDMA_spikes_summary.csv')

# motion merge
mergedDf=merge(mot,allScans,by=c('Subjects','Task','Dosage'))
mergedDf=mergedDf[mergedDf$Dosage!='baseline',]
mergedDf$Drug=0
mergedDf$Drug[mergedDf$Dosage=="120mg"]=1
mergedDf$Drug[mergedDf$Dosage=="80mg"]=1
mergedDf$Drug=as.factor(mergedDf$Drug)
mergedDf$Subjects<-as.factor(mergedDf$Subjects)
mergedDf$Dosage<-as.factor(mergedDf$Dosage)
mergedDfProps=mergedDf


# saveout merged DF for facewise analyses on HPC
saveRDS(mergedDf,'~/P50_cleaned_df.rds')
```

```{r}
# remove data that needs to be removed (subs 6 and 10, <250 TRs)
mergedDf=mergedDf[mergedDf$Subjects!='sub-MDMA006',]
mergedDf=mergedDf[mergedDf$Subjects!='sub-MDMA010',]
mergedDf=mergedDf[mergedDf$RemTRs>250,]

# change rs2 to rs for accurate task-modeling
mergedDf$Task[mergedDf$Task=='rs2']='rs'
mergedDf$Task=as.factor(mergedDf$Task)

# set rs to reference level
#mergedDf <- within(mergedDf, Task <- relevel(Task, ref = 2))

# model
model <- lme(TDProp2 ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDf)

# subset for p-80
df_plot1=mergedDf[mergedDf$Dosage!="120mg",]
# for p-120
df_plot2=mergedDf[mergedDf$Dosage!="80mg",]

df_plot1$SubjectTask <- interaction(df_plot1$Subjects, df_plot1$Task)
df_plot2$SubjectTask <- interaction(df_plot2$Subjects, df_plot2$Task)

# Plotting
ggplot(df_plot1, aes(x = Drug, y = TDProp2, fill = Drug, group = SubjectTask, color = Subjects)) +
  geom_point(size = 4, aes(alpha = 0.7)) +
  geom_line() +
  geom_point(data = df_plot2, aes(color = Subjects,alpha=.7), size = 4) +
  geom_line(data = df_plot2, aes(group = SubjectTask, color = Subjects)) +
  scale_color_viridis_d(option = "plasma") +
  ggtitle('All Scans') +
  theme_minimal(base_size = 22)

summary(model)

# and plot each task separately to gauge samples needed for robust effect
# RS
mergedDfT=mergedDf[mergedDf$Task=='rs',]
mergedDfT2=mergedDf[mergedDf$Task=='rs2',]
mergedDfT=rbind(mergedDfT,mergedDfT2)
# model
model <- lme(TDProp1 ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDfT)
# subset for p-80
df_plot1=mergedDfT[mergedDfT$Dosage!="120mg",]
# for p-120
df_plot2=mergedDfT[mergedDfT$Dosage!="80mg",]

df_plot1$SubjectTask <- interaction(df_plot1$Subjects, df_plot1$Task)
df_plot2$SubjectTask <- interaction(df_plot2$Subjects, df_plot2$Task)

# plot
ggplot(df_plot1, aes(x = Drug, y = TDProp1, fill = Drug, group = SubjectTask, color = Subjects)) +
  geom_point(size = 4, aes(alpha = 0.7)) +
  geom_line() +
  geom_point(data = df_plot2, aes(color = Subjects,alpha=.7), size = 4) +
  geom_line(data = df_plot2, aes(group = SubjectTask, color = Subjects)) +
  scale_color_viridis_d(option = "plasma") +
  ggtitle('Resting-state') +
  theme_minimal(base_size = 22)

# model output
summary(model)

# WM
mergedDfT=mergedDf[mergedDf$Task=='wm',]
# model
model <- lme(TDProp1 ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDfT)
# subset for p-80
df_plot1=mergedDfT[mergedDfT$Dosage!="120mg",]
# for p-120
df_plot2=mergedDfT[mergedDfT$Dosage!="80mg",]

df_plot1$SubjectTask <- interaction(df_plot1$Subjects, df_plot1$Task)
df_plot2$SubjectTask <- interaction(df_plot2$Subjects, df_plot2$Task)


# plot
ggplot(df_plot1, aes(x = Drug, y = TDProp1, fill = Drug, group = SubjectTask, color = Subjects)) +
  geom_point(size = 4, aes(alpha = 0.7)) +
  geom_line() +
  geom_point(data = df_plot2, aes(color = Subjects,alpha=.7), size = 4) +
  geom_line(data = df_plot2, aes(group = SubjectTask, color = Subjects)) +
  scale_color_viridis_d(option = "plasma") +
  ggtitle('Working Memory') +
  theme_minimal(base_size = 22)

# model output
summary(model)

# gambling
mergedDfT=mergedDf[mergedDf$Task=='gambling',]
# model
model <- lme(TDProp1 ~ MeanFD + Drug + RemTRs, random = ~ 1 | Subjects, data = mergedDfT)
# subset for p-80
df_plot1=mergedDfT[mergedDfT$Dosage!="120mg",]
# for p-120
df_plot2=mergedDfT[mergedDfT$Dosage!="80mg",]

df_plot1$SubjectTask <- interaction(df_plot1$Subjects, df_plot1$Task)
df_plot2$SubjectTask <- interaction(df_plot2$Subjects, df_plot2$Task)


# plot
ggplot(df_plot1, aes(x = Drug, y = TDProp1, fill = Drug, group = SubjectTask, color = Subjects)) +
  geom_point(size = 4, aes(alpha = 0.7)) +
  geom_line() +
  geom_point(data = df_plot2, aes(color = Subjects,alpha=.7), size = 4) +
  geom_line(data = df_plot2, aes(group = SubjectTask, color = Subjects)) +
  scale_color_viridis_d(option = "plasma") +
  ggtitle('Gambling') +
  theme_minimal(base_size = 22)
# model output
summary(model)

```

```{r}
#meltedDf <- melt(mergedDf, id.vars = c("Subjects", "Task", "Dosage", "Session", "SpikesPercent", "MeanFD", "RemTRs", "Drug"))
#meltedDf <- within(meltedDf, variable <- relevel(variable, ref = 3))
#model <- lme(value ~ MeanFD + Drug + RemTRs+variable+variable*Drug+MeanFD*variable+RemTRs*variable, random = ~ 1 | Subjects/variable, data = meltedDf)
#summary(model)
#sjPlot::plot_model(model, type = "eff",show.values = T)
#
## great, now let's bootstrap it
## Set the number of bootstrap samples
#num_bootstrap_samples <- 1000
## initialize t vectors
#td1_d<-zeros(num_bootstrap_samples,1)
#td1_fd<-zeros(num_bootstrap_samples,1)
#td2_d<-zeros(num_bootstrap_samples,1)
#td2_fd<-zeros(num_bootstrap_samples,1)
#td3_d<-zeros(num_bootstrap_samples,1)
#td3_fd<-zeros(num_bootstrap_samples,1)
#td4_d<-zeros(num_bootstrap_samples,1)
#td4_fd<-zeros(num_bootstrap_samples,1)
#
## bootstrap loops
#set.seed(420)
#for (i in 1:num_bootstrap_samples){
#  # resample subjects instead of observations to be conserative
#	BootSubjs=sample(unique(mergedDf$Subjects),14,replace=T)
#	# Create an empty dataframe to store the resampled observations
#	bootSamp <- data.frame()
#	for (j in 1:length(BootSubjs)){
#		subject_obs <- meltedDf[meltedDf$Subjects == BootSubjs[j], ]
#		bootSamp <- rbind(bootSamp, subject_obs)
#	}
#  # fit model
#  model_i <- lme(value ~ MeanFD + Drug + RemTRs+variable+variable*Drug+variable*MeanFD, random = ~ 1 | Subjects/variable, data = bootSamp)
#  # get t-values
#  td1_d[i]=summary(model_i)$tTable[rownames(summary(model_i)$tTable) == "Drug1:variableTDProp1", "t-value"]
#  td1_fd[i]=summary(model_i)$tTable[rownames(summary(model_i)$tTable) == "MeanFD:variableTDProp1", "t-value"]
#  td3_d[i]=summary(model_i)$tTable[rownames(summary(model_i)$tTable) == "Drug1:variableTDProp3", "t-value"]
#  td3_fd[i]=summary(model_i)$tTable[rownames(summary(model_i)$tTable) == "MeanFD:variableTDProp3", "t-value"]
#  td4_d[i]=summary(model_i)$tTable[rownames(summary(model_i)$tTable) == "Drug1:variableTDProp4", "t-value"]
#  td4_fd[i]=summary(model_i)$tTable[rownames(summary(model_i)$tTable) == "MeanFD:variableTDProp4", "t-value"]
#}
#
#bootstrap_results=data.frame(cbind(td1_d,td1_fd,td3_d,td3_fd,td4_d,td4_fd))
#colnames(bootstrap_results)=c('td1_drug','td1_fd','td3_drug','td3_fd','td4_drug','td4_fd')
#plotdf=melt(bootstrap_results)
#
## Create box-and-whisker plots
#ggplot(plotdf, aes(x = variable, y = value,)) +
#  geom_boxplot(position = position_dodge(width = 0.8)) +
#  labs(x = "Model", y = "T-Values", title = "Bootstrap T-Values for Drug and MeanFD") +
#  theme_minimal(base_size = 16)+scale_fill_manual(values=c('blue','red'))
```

```{r}
# complexity
rs1=read.csv('~/Downloads/P50 MDMA/rs1_complexityMerged.csv',header=F)
rs2=read.csv('~/Downloads/P50 MDMA/rs2_complexityMerged.csv',header=F)
emo=read.csv('~/Downloads/P50 MDMA/emotion_complexityMerged.csv',header=F)
gambling=read.csv('~/Downloads/P50 MDMA/gambling_complexityMerged.csv',header=F)
wm=read.csv('~/Downloads/P50 MDMA/wm_complexityMerged.csv',header=F)
# set colnames
#colnames(rs1)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(rs2)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(emo)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(gambling)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(wm)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
rs1$Task='rs'
rs2$Task='rs2'
emo$Task='emotion'
gambling$Task='gambling'
wm$Task='wm'

# remove subj 4
rs1=rs1[-c(4),]
rs2=rs2[-c(4),]
emo=emo[-c(4),]
gambling=gambling[-c(4),]
wm=wm[-c(4),]

# this is going to be ugly but simple
# manually pair columns as sep. observations of baseline, placebo, 80, 120mg
rs1bv=data.frame(cbind(rs1$V1,rs1$V5))
rs1p=data.frame(cbind(rs1$V2,rs1$V6))
rs1m1=data.frame(cbind(rs1$V3,rs1$V7))
rs1m2=data.frame(cbind(rs1$V4,rs1$V8))
colnames(rs1bv)=c('Complexity','RemTRs')
colnames(rs1p)=c('Complexity','RemTRs')
colnames(rs1m1)=c('Complexity','RemTRs')
colnames(rs1m2)=c('Complexity','RemTRs')

rs2bv=data.frame(cbind(rs2$V1,rs2$V5))
rs2p=data.frame(cbind(rs2$V2,rs2$V6))
rs2m1=data.frame(cbind(rs2$V3,rs2$V7))
rs2m2=data.frame(cbind(rs2$V4,rs2$V8))
colnames(rs2bv)=c('Complexity','RemTRs')
colnames(rs2p)=c('Complexity','RemTRs')
colnames(rs2m1)=c('Complexity','RemTRs')
colnames(rs2m2)=c('Complexity','RemTRs')

emobv=data.frame(cbind(emo$V1,emo$V5))
emop=data.frame(cbind(emo$V2,emo$V6))
emom1=data.frame(cbind(emo$V3,emo$V7))
emom2=data.frame(cbind(emo$V4,emo$V8))
colnames(emobv)=c('Complexity','RemTRs')
colnames(emop)=c('Complexity','RemTRs')
colnames(emom1)=c('Complexity','RemTRs')
colnames(emom2)=c('Complexity','RemTRs')

gamblingbv=data.frame(cbind(gambling$V1,gambling$V5))
gamblingp=data.frame(cbind(gambling$V2,gambling$V6))
gamblingm1=data.frame(cbind(gambling$V3,gambling$V7))
gamblingm2=data.frame(cbind(gambling$V4,gambling$V8))
colnames(gamblingbv)=c('Complexity','RemTRs')
colnames(gamblingp)=c('Complexity','RemTRs')
colnames(gamblingm1)=c('Complexity','RemTRs')
colnames(gamblingm2)=c('Complexity','RemTRs')

wmbv=data.frame(cbind(wm$V1,wm$V5))
wmp=data.frame(cbind(wm$V2,wm$V6))
wmm1=data.frame(cbind(wm$V3,wm$V7))
wmm2=data.frame(cbind(wm$V4,wm$V8))
colnames(wmbv)=c('Complexity','RemTRs')
colnames(wmp)=c('Complexity','RemTRs')
colnames(wmm1)=c('Complexity','RemTRs')
colnames(wmm2)=c('Complexity','RemTRs')

# get subject IDs from this rds
alff=readRDS('~/OutPlacDrug_alff.rds')
rs1bv$Subjects=alff$SubjID
rs1p$Subjects=alff$SubjID
rs1m1$Subjects=alff$SubjID
rs1m2$Subjects=alff$SubjID

rs2bv$Subjects=alff$SubjID
rs2p$Subjects=alff$SubjID
rs2m1$Subjects=alff$SubjID
rs2m2$Subjects=alff$SubjID

emobv$Subjects=alff$SubjID
emop$Subjects=alff$SubjID
emom1$Subjects=alff$SubjID
emom2$Subjects=alff$SubjID

gamblingbv$Subjects=alff$SubjID
gamblingp$Subjects=alff$SubjID
gamblingm1$Subjects=alff$SubjID
gamblingm2$Subjects=alff$SubjID

wmbv$Subjects=alff$SubjID
wmp$Subjects=alff$SubjID
wmm1$Subjects=alff$SubjID
wmm2$Subjects=alff$SubjID

# add in task (rs to be made equivalent after motion merge)
rs1bv$Task='rs'
rs1p$Task='rs'
rs1m1$Task='rs'
rs1m2$Task='rs'

rs2bv$Task='rs2'
rs2p$Task='rs2'
rs2m1$Task='rs2'
rs2m2$Task='rs2'

emobv$Task='emotion'
emop$Task='emotion'
emom1$Task='emotion'
emom2$Task='emotion'

gamblingbv$Task='gambling'
gamblingp$Task='gambling'
gamblingm1$Task='gambling'
gamblingm2$Task='gambling'

wmbv$Task='wm'
wmp$Task='wm'
wmm1$Task='wm'
wmm2$Task='wm'

# add in dosage
rs1bv$Dosage='baseline'
rs1p$Dosage='Placebo'
rs1m1$Dosage='80mg'
rs1m2$Dosage='120mg'

rs2bv$Dosage='baseline'
rs2p$Dosage='Placebo'
rs2m1$Dosage='80mg'
rs2m2$Dosage='120mg'

emobv$Dosage='baseline'
emop$Dosage='Placebo'
emom1$Dosage='80mg'
emom2$Dosage='120mg'

gamblingbv$Dosage='baseline'
gamblingp$Dosage='Placebo'
gamblingm1$Dosage='80mg'
gamblingm2$Dosage='120mg'

wmbv$Dosage='baseline'
wmp$Dosage='Placebo'
wmm1$Dosage='80mg'
wmm2$Dosage='120mg'

# comibine all
allScans=rbind(rs1bv,rs1p,rs1m1,rs1m2,rs2bv,rs2p,rs2m1,rs2m2,emobv,emop,emom1,emom2,gamblingbv,gamblingp,gamblingm1,gamblingm2,wmbv,wmp,wmm1,wmm2)

# read in motion
mot=read.csv('~/Desktop/MDMA_spikes_summary.csv')

# motion merge
mergedDf=merge(mot,allScans,by=c('Subjects','Task','Dosage'))
mergedDf=mergedDf[mergedDf$Dosage!='baseline',]
mergedDf$Drug=0
mergedDf$Drug[mergedDf$Dosage=="120mg"]=1
mergedDf$Drug[mergedDf$Dosage=="80mg"]=1
mergedDf$Drug=as.factor(mergedDf$Drug)

mergedDfPropsCompl=merge(mergedDfProps,mergedDf,by=c("Subjects","Task","Dosage","Session","MeanFD","SpikesPercent","RemTRs","Drug"))

```

```{r}
# autocorrelation
rs1=read.csv('~/Downloads/P50 MDMA/rs1_autocorMerged.csv',header=F)
rs2=read.csv('~/Downloads/P50 MDMA/rs2_autocorMerged.csv',header=F)
emo=read.csv('~/Downloads/P50 MDMA/emotion_autocorMerged.csv',header=F)
gambling=read.csv('~/Downloads/P50 MDMA/gambling_autocorMerged.csv',header=F)
wm=read.csv('~/Downloads/P50 MDMA/wm_autocorMerged.csv',header=F)
# set colnames
#colnames(rs1)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(rs2)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(emo)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(gambling)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(wm)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
rs1$Task='rs'
rs2$Task='rs2'
emo$Task='emotion'
gambling$Task='gambling'
wm$Task='wm'

# remove subj 4
rs1=rs1[-c(4),]
rs2=rs2[-c(4),]
emo=emo[-c(4),]
gambling=gambling[-c(4),]
wm=wm[-c(4),]

# this is going to be ugly but simple
# manually pair columns as sep. observations of baseline, placebo, 80, 120mg
rs1bv=data.frame(cbind(rs1$V1,rs1$V5))
rs1p=data.frame(cbind(rs1$V2,rs1$V6))
rs1m1=data.frame(cbind(rs1$V3,rs1$V7))
rs1m2=data.frame(cbind(rs1$V4,rs1$V8))
colnames(rs1bv)=c('AutoCor','RemTRs')
colnames(rs1p)=c('AutoCor','RemTRs')
colnames(rs1m1)=c('AutoCor','RemTRs')
colnames(rs1m2)=c('AutoCor','RemTRs')

rs2bv=data.frame(cbind(rs2$V1,rs2$V5))
rs2p=data.frame(cbind(rs2$V2,rs2$V6))
rs2m1=data.frame(cbind(rs2$V3,rs2$V7))
rs2m2=data.frame(cbind(rs2$V4,rs2$V8))
colnames(rs2bv)=c('AutoCor','RemTRs')
colnames(rs2p)=c('AutoCor','RemTRs')
colnames(rs2m1)=c('AutoCor','RemTRs')
colnames(rs2m2)=c('AutoCor','RemTRs')

emobv=data.frame(cbind(emo$V1,emo$V5))
emop=data.frame(cbind(emo$V2,emo$V6))
emom1=data.frame(cbind(emo$V3,emo$V7))
emom2=data.frame(cbind(emo$V4,emo$V8))
colnames(emobv)=c('AutoCor','RemTRs')
colnames(emop)=c('AutoCor','RemTRs')
colnames(emom1)=c('AutoCor','RemTRs')
colnames(emom2)=c('AutoCor','RemTRs')

gamblingbv=data.frame(cbind(gambling$V1,gambling$V5))
gamblingp=data.frame(cbind(gambling$V2,gambling$V6))
gamblingm1=data.frame(cbind(gambling$V3,gambling$V7))
gamblingm2=data.frame(cbind(gambling$V4,gambling$V8))
colnames(gamblingbv)=c('AutoCor','RemTRs')
colnames(gamblingp)=c('AutoCor','RemTRs')
colnames(gamblingm1)=c('AutoCor','RemTRs')
colnames(gamblingm2)=c('AutoCor','RemTRs')

wmbv=data.frame(cbind(wm$V1,wm$V5))
wmp=data.frame(cbind(wm$V2,wm$V6))
wmm1=data.frame(cbind(wm$V3,wm$V7))
wmm2=data.frame(cbind(wm$V4,wm$V8))
colnames(wmbv)=c('AutoCor','RemTRs')
colnames(wmp)=c('AutoCor','RemTRs')
colnames(wmm1)=c('AutoCor','RemTRs')
colnames(wmm2)=c('AutoCor','RemTRs')

# get subject IDs from this rds
alff=readRDS('~/OutPlacDrug_alff.rds')
rs1bv$Subjects=alff$SubjID
rs1p$Subjects=alff$SubjID
rs1m1$Subjects=alff$SubjID
rs1m2$Subjects=alff$SubjID

rs2bv$Subjects=alff$SubjID
rs2p$Subjects=alff$SubjID
rs2m1$Subjects=alff$SubjID
rs2m2$Subjects=alff$SubjID

emobv$Subjects=alff$SubjID
emop$Subjects=alff$SubjID
emom1$Subjects=alff$SubjID
emom2$Subjects=alff$SubjID

gamblingbv$Subjects=alff$SubjID
gamblingp$Subjects=alff$SubjID
gamblingm1$Subjects=alff$SubjID
gamblingm2$Subjects=alff$SubjID

wmbv$Subjects=alff$SubjID
wmp$Subjects=alff$SubjID
wmm1$Subjects=alff$SubjID
wmm2$Subjects=alff$SubjID

# add in task (rs to be made equivalent after motion merge)
rs1bv$Task='rs'
rs1p$Task='rs'
rs1m1$Task='rs'
rs1m2$Task='rs'

rs2bv$Task='rs2'
rs2p$Task='rs2'
rs2m1$Task='rs2'
rs2m2$Task='rs2'

emobv$Task='emotion'
emop$Task='emotion'
emom1$Task='emotion'
emom2$Task='emotion'

gamblingbv$Task='gambling'
gamblingp$Task='gambling'
gamblingm1$Task='gambling'
gamblingm2$Task='gambling'

wmbv$Task='wm'
wmp$Task='wm'
wmm1$Task='wm'
wmm2$Task='wm'

# add in dosage
rs1bv$Dosage='baseline'
rs1p$Dosage='Placebo'
rs1m1$Dosage='80mg'
rs1m2$Dosage='120mg'

rs2bv$Dosage='baseline'
rs2p$Dosage='Placebo'
rs2m1$Dosage='80mg'
rs2m2$Dosage='120mg'

emobv$Dosage='baseline'
emop$Dosage='Placebo'
emom1$Dosage='80mg'
emom2$Dosage='120mg'

gamblingbv$Dosage='baseline'
gamblingp$Dosage='Placebo'
gamblingm1$Dosage='80mg'
gamblingm2$Dosage='120mg'

wmbv$Dosage='baseline'
wmp$Dosage='Placebo'
wmm1$Dosage='80mg'
wmm2$Dosage='120mg'

# comibine all
allScans=rbind(rs1bv,rs1p,rs1m1,rs1m2,rs2bv,rs2p,rs2m1,rs2m2,emobv,emop,emom1,emom2,gamblingbv,gamblingp,gamblingm1,gamblingm2,wmbv,wmp,wmm1,wmm2)

# read in motion
mot=read.csv('~/Desktop/MDMA_spikes_summary.csv')

# motion merge
mergedDf=merge(mot,allScans,by=c('Subjects','Task','Dosage'))
mergedDf=mergedDf[mergedDf$Dosage!='baseline',]
mergedDf$Drug=0
mergedDf$Drug[mergedDf$Dosage=="120mg"]=1
mergedDf$Drug[mergedDf$Dosage=="80mg"]=1
mergedDf$Drug=as.factor(mergedDf$Drug)
```

```{r}
# combine complexity and props
mergedDfPropsComplAutoC=merge(mergedDfPropsCompl,mergedDf,by=c("Subjects","Task","Dosage","Session","MeanFD","SpikesPercent","RemTRs","Drug"))
```

```{r}
# remove data that needs to be removed (subs 6 and 10, <250 TRs)
mergedDfPropsComplAutoC=mergedDfPropsComplAutoC[mergedDfPropsComplAutoC$Subjects!='sub-MDMA006',]
mergedDfPropsComplAutoC=mergedDfPropsComplAutoC[mergedDfPropsComplAutoC$Subjects!='sub-MDMA010',]
mergedDfPropsComplAutoC=mergedDfPropsComplAutoC[mergedDfPropsComplAutoC$RemTRs>250,]

# change rs2 to rs for accurate task-modeling
mergedDfPropsComplAutoC$Task[mergedDfPropsComplAutoC$Task=='rs2']='rs'
mergedDfPropsComplAutoC$Task=as.factor(mergedDfPropsComplAutoC$Task)

# set rs to reference level
mergedDfPropsComplAutoC <- within(mergedDfPropsComplAutoC, Task <- relevel(Task, ref = 2))

# model
td_model <- lme(TDProp1 ~ MeanFD + Drug, random = ~ 1 | Subjects, data = mergedDfPropsComplAutoC)
sa_model <- lme(AutoCor ~ MeanFD + Drug, random = ~ 1 | Subjects, data = mergedDfPropsComplAutoC)
cx_model <- lme(Complexity ~ MeanFD + Drug, random = ~ 1 | Subjects, data = mergedDfPropsComplAutoC)
```

```{r}
# great, now let's bootstrap them
# Set the number of bootstrap samples
num_bootstrap_samples <- 1000
# initialize t vectors
td_d<-zeros(num_bootstrap_samples,1)
td_fd<-zeros(num_bootstrap_samples,1)
sa_d<-zeros(num_bootstrap_samples,1)
sa_fd<-zeros(num_bootstrap_samples,1)
cx_d<-zeros(num_bootstrap_samples,1)
cx_fd<-zeros(num_bootstrap_samples,1)

# bootstrap loops
set.seed(420)
for (i in 1:num_bootstrap_samples){
  # resample data
  data=mergedDfPropsComplAutoC[sample(nrow(mergedDfPropsComplAutoC), replace = TRUE), ]
  # fit on all models
  td_model <- lme(TDProp1 ~ MeanFD + Drug, random = ~ 1 | Subjects, data = data)
  sa_model <- lme(AutoCor ~ MeanFD + Drug, random = ~ 1 | Subjects, data = data)
  cx_model <- lme(Complexity ~ MeanFD + Drug, random = ~ 1 | Subjects, data = data)
  # get t-values
  td_d[i]=summary(td_model)$tTable[rownames(summary(td_model)$tTable) == "Drug1", "t-value"]
  td_fd[i]=summary(td_model)$tTable[rownames(summary(td_model)$tTable) == "MeanFD", "t-value"]
  sa_d[i]=summary(sa_model)$tTable[rownames(summary(sa_model)$tTable) == "Drug1", "t-value"]
  sa_fd[i]=summary(sa_model)$tTable[rownames(summary(sa_model)$tTable) == "MeanFD", "t-value"]
  cx_d[i]=summary(cx_model)$tTable[rownames(summary(cx_model)$tTable) == "Drug1", "t-value"]
  cx_fd[i]=summary(cx_model)$tTable[rownames(summary(cx_model)$tTable) == "MeanFD", "t-value"]
  
}
# convert to dataframes
td_d=data.frame(td_d)
sa_d=data.frame(sa_d)
cx_d=data.frame(cx_d)
td_fd=data.frame(td_fd)
sa_fd=data.frame(sa_fd)
cx_fd=data.frame(cx_fd)
colnames(td_d)='tstat'
colnames(sa_d)='tstat'
colnames(cx_d)='tstat'
colnames(td_fd)='tstat'
colnames(sa_fd)='tstat'
colnames(cx_fd)='tstat'

# set column names for merging
td_d$Cov='Drug'
sa_d$Cov='Drug'
cx_d$Cov='Drug'
td_fd$Cov='FD'
sa_fd$Cov='FD'
cx_fd$Cov='FD'
td_d$Model='Top-Down'
sa_d$Model='AutoCor'
cx_d$Model='Complexity'
td_fd$Model='Top-Down'
sa_fd$Model='AutoCor'
cx_fd$Model='Complexity'
bootstrap_results=rbind(td_fd,td_d,sa_d,sa_fd,cx_d,cx_fd)

# Create box-and-whisker plots
ggplot(bootstrap_results, aes(x = Model, y = abs(tstat), fill = Cov)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(x = "Model", y = "T-Values", title = "Bootstrap T-Values for Drug and MeanFD") +
  theme_minimal(base_size = 16)+scale_fill_manual(values=c('blue','red'))

```


```{r}
library(sjPlot)
# visualize
sjPlot::plot_model(model, type = "eff",show.values = T)

# summarize
summary(model)

# Summarize the model
model_summary <- summary(model)


```

```{r}
# now compare with VAS
vas=read.csv('~/Downloads/MDMA_VAS_ASC_forAdam_03062023.csv')
# correct subject naming
vas$Subjects <- paste0("sub-MDMA", sprintf("%03d", vas$Subjects))
VASmerge=merge(vas,mergedDfPropsCompl,by=c("Subjects","Dosage"))

# TD PROP
# initialize correlation vector for dasc
corvec=NULL
pvec=NULL
colNameVec=NULL
for (i in 40:56){
  das_col <- colnames(VASmerge)[i]
  print(das_col)
  formula_str <- paste(das_col, "~ MeanFD + TDProp2")
  df = na.omit(VASmerge[,c(das_col,'MeanFD','TDProp2','Subjects')])
  currModel <- lme(as.formula(formula_str), random = ~ 1 | Subjects, data = df)
  corvec[i-39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "TDProp2", "t-value"]
  pvec[i-39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "TDProp2", "p-value"]
#  corvec[i-2]=cor.test(VASmerge$TDProp,VASmerge[,i])$estimate
#  pvec[i-2]=cor.test(VASmerge$TDProp,VASmerge[,i])$p.value
  colNameVec[i-39]=colnames(VASmerge)[i]
  print(summary(currModel)$tTable)
}

# Create a dataframe with the values and column names
df <- data.frame(Values = corvec, ColumnNames = colNameVec)

# Order the ColumnNames as an ordered factor based on the Values
df$ColumnNames <- factor(df$ColumnNames, levels = df$ColumnNames[order(df$Values, decreasing = FALSE)])

# make a color vector by significance
fdrp=p.adjust(pvec,method='fdr')
colorvec=rep('NS',length(fdrp))
colorvec[pvec<.05]='Uncr'
colorvec[fdrp<.05]='FDR'
df$Sig <- factor(colorvec, levels = c('NS', 'Uncr', 'FDR'))
# Specify color scale manually
colors <- c('NS' = 'gray', 'Uncr' = 'blue', 'FDR' = 'red')
# Create the plot using ggplot
ggplot(df, aes(x = Values, y = ColumnNames,color=Sig)) +
  geom_point(size=3) + xlim(-20,20)+
  scale_color_manual(values = colors) +
  labs(x = "Values", y = "DAS Questions",title="Association with TD Props")+theme_minimal(base_size=26)

  
# DRUG
# initialize correlation vector for dasc
corvec=NULL
pvec=NULL
colNameVec=NULL
for (i in 40:56){
  das_col <- colnames(VASmerge)[i]
  print(das_col)
  formula_str <- paste(das_col, "~ MeanFD + Drug")
  df = na.omit(VASmerge[,c(das_col,'MeanFD','Drug','Subjects')])
  currModel <- lme(as.formula(formula_str), random = ~ 1 | Subjects, data = df)
  corvec[i-39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "Drug1", "t-value"]
  pvec[i-39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "Drug1", "p-value"]
#  corvec[i-2]=cor.test(VASmerge$TDProp,VASmerge[,i])$estimate
#  pvec[i-2]=cor.test(VASmerge$TDProp,VASmerge[,i])$p.value
  colNameVec[i-39]=colnames(VASmerge)[i]
  print(summary(currModel)$tTable)
}

# Create a dataframe with the values and column names
df <- data.frame(Values = corvec, ColumnNames = colNameVec)

# Order the ColumnNames as an ordered factor based on the Values
df$ColumnNames <- factor(df$ColumnNames, levels = df$ColumnNames[order(df$Values, decreasing = FALSE)])
# make a color vector by significance
fdrp=p.adjust(pvec,method='fdr')
colorvec=rep('NS',length(fdrp))
colorvec[pvec<.05]='Uncr'
colorvec[fdrp<.05]='FDR'
df$Sig <- factor(colorvec, levels = c('NS', 'Uncr', 'FDR'))
# Specify color scale manually
colors <- c('NS' = 'gray', 'Uncr' = 'blue', 'FDR' = 'red')
# Create the plot using ggplot
ggplot(df, aes(x = Values, y = ColumnNames,color=Sig)) +
  geom_point(size=3) + xlim(-20,20)+
  scale_color_manual(values = colors) +
  labs(x = "Values", y = "DAS Questions",title="Association with Drug")+theme_minimal(base_size=26)



# TD, COV DRUG
# initialize correlation vector for dasc
corvec=NULL
corvecD=NULL
pvec=NULL
pvecD=NULL
colNameVec=NULL
for (i in 40:56){
  das_col <- colnames(VASmerge)[i]
  print(das_col)
  formula_str <- paste(das_col, "~ MeanFD + TDProp2 + Drug")
  df = na.omit(VASmerge[,c(das_col,'MeanFD','TDProp2','Subjects','Drug')])
  currModel <- lme(as.formula(formula_str), random = ~ 1 | Subjects, data = df)
  corvec[i-39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "TDProp2", "t-value"]
  corvecD[i-39]<- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "Drug1", "t-value"]
  pvec[i-39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "TDProp2", "p-value"]
  pvecD[i-39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "Drug1", "p-value"]
#  corvec[i-2]=cor.test(VASmerge$TDProp,VASmerge[,i])$estimate
#  pvec[i-2]=cor.test(VASmerge$TDProp,VASmerge[,i])$p.value
  colNameVec[i-39]=colnames(VASmerge)[i]
  print(summary(currModel)$tTable)
}

# Create a dataframe with the values and column names
df <- data.frame(Values = corvec, ColumnNames = colNameVec)

# Order the ColumnNames as an ordered factor based on the Values
df$ColumnNames <- factor(df$ColumnNames, levels = df$ColumnNames[order(df$Values, decreasing = FALSE)])

# Order the ColumnNames as an ordered factor based on the Values
df$ColumnNames <- factor(df$ColumnNames, levels = df$ColumnNames[order(df$Values, decreasing = FALSE)])
# make a color vector by significance
fdrp=p.adjust(pvec,method='fdr')
colorvec=rep('NS',length(fdrp))
colorvec[pvec<.05]='Uncr'
colorvec[fdrp<.05]='FDR'
df$Sig <- factor(colorvec, levels = c('NS', 'Uncr', 'FDR'))
# Specify color scale manually
colors <- c('NS' = 'gray', 'Uncr' = 'blue', 'FDR' = 'red')
# Create the plot using ggplot
ggplot(df, aes(x = Values, y = ColumnNames,color=Sig)) +
  geom_point(size=3) + xlim(-20,20)+
  scale_color_manual(values = colors) +
  labs(x = "Values", y = "DAS Questions",title="TD Props, Covarying for Drug")+theme_minimal(base_size=26)

# drug covarying for td
# Create a dataframe with the values and column names
df <- data.frame(Values = corvecD, ColumnNames = colNameVec)

# Order the ColumnNames as an ordered factor based on the Values
df$ColumnNames <- factor(df$ColumnNames, levels = df$ColumnNames[order(df$Values, decreasing = FALSE)])

# Order the ColumnNames as an ordered factor based on the Values
df$ColumnNames <- factor(df$ColumnNames, levels = df$ColumnNames[order(df$Values, decreasing = FALSE)])
# make a color vector by significance
fdrp=p.adjust(pvecD,method='fdr')
colorvec=rep('NS',length(fdrp))
colorvec[pvecD<.05]='Uncr'
colorvec[fdrp<.05]='FDR'
df$Sig <- factor(colorvec, levels = c('NS', 'Uncr', 'FDR'))
# Specify color scale manually
colors <- c('NS' = 'gray', 'Uncr' = 'blue', 'FDR' = 'red')
# Create the plot using ggplot
ggplot(df, aes(x = Values, y = ColumnNames,color=Sig)) +
  geom_point(size=3) + xlim(-20,20)+
  scale_color_manual(values = colors) +
  labs(x = "Values", y = "DAS Questions",title="Drug, Covarying for TDProps")+theme_minimal(base_size=26)
```
```{r}
library(ggplot2)

# Combine the two conditions into a single data frame
VASmerge <- merge(vas, mergedDfPropsCompl, by = c("Subjects", "Dosage"))

# TD PROP
# initialize correlation vector for dasc
corvec_tdprop <- pvec_tdprop <- colNameVec_tdprop <- NULL
for (i in 40:56) {
  das_col <- colnames(VASmerge)[i]
  print(das_col)
  formula_str <- paste(das_col, "~ MeanFD + TDProp")
  df <- na.omit(VASmerge[, c(das_col, 'MeanFD', 'TDProp', 'Subjects')])
  currModel <- lme(as.formula(formula_str), random = ~ 1 | Subjects, data = df)
  corvec_tdprop[i - 39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "TDProp", "t-value"]
  pvec_tdprop[i - 39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "TDProp", "p-value"]
  colNameVec_tdprop[i - 39] <- colnames(VASmerge)[i]
  print(summary(currModel)$tTable)
}

# Create a dataframe with the values and column names for TD PROP
df_tdprop <- data.frame(Values = corvec_tdprop, ColumnNames = colNameVec_tdprop)
df_tdprop$ColumnNames <- factor(df_tdprop$ColumnNames, levels = df_tdprop$ColumnNames[order(df_tdprop$Values, decreasing = FALSE)])
# make a color vector by significance
fdrp_tdprop <- p.adjust(pvec_tdprop, method = 'fdr')
colorvec_tdprop <- rep('NS', length(fdrp_tdprop))
colorvec_tdprop[pvec_tdprop < .05] <- 'Uncr'
colorvec_tdprop[fdrp_tdprop < .05] <- 'FDR'
df_tdprop$Sig <- factor(colorvec_tdprop, levels = c('NS', 'Uncr', 'FDR'))

# DRUG
# initialize correlation vector for dasc
corvec_drug <- pvec_drug <- colNameVec_drug <- NULL
for (i in 40:56) {
  das_col <- colnames(VASmerge)[i]
  print(das_col)
  formula_str <- paste(das_col, "~ MeanFD + Drug")
  df <- na.omit(VASmerge[, c(das_col, 'MeanFD', 'Drug', 'Subjects')])
  currModel <- lme(as.formula(formula_str), random = ~ 1 | Subjects, data = df)
  corvec_drug[i - 39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "Drug1", "t-value"]
  pvec_drug[i - 39] <- summary(currModel)$tTable[rownames(summary(currModel)$tTable) == "Drug1", "p-value"]
  colNameVec_drug[i - 39] <- colnames(VASmerge)[i]
  print(summary(currModel)$tTable)
}

# Create a dataframe with the values and column names for DRUG
df_drug <- data.frame(Values = corvec_drug, ColumnNames = colNameVec_drug)
df_drug$ColumnNames <- factor(df_drug$ColumnNames, levels = df_drug$ColumnNames[order(df_drug$Values, decreasing = FALSE)])
# make a color vector by significance
fdrp_drug <- p.adjust(pvec_drug, method = 'fdr')
colorvec_drug <- rep('NS', length(fdrp_drug))
colorvec_drug[pvec_drug < .05] <- 'Uncr'
colorvec_drug[fdrp_drug < .05] <- 'FDR'
df_drug$Sig <- factor(colorvec_drug, levels = c('NS', 'Uncr', 'FDR'))

# TD, COV DRUG
# initialize correlation vector for dasc
corvec_tdprop_cov_drug <- corvec_drug_cov_tdprop <- pvec_tdprop_cov_drug <- pvec_drug_cov_tdprop <- colNameVec_tdprop_cov_drug <- NULL
for (i in 40:56) {
  das_col <- colnames(VASmerge)[i]
  print(das_col)
  formula_str_tdprop_cov_drug <- paste(das_col, "~ MeanFD + TDProp + Drug")
  df_tdprop_cov_drug <- na.omit(VASmerge[, c(das_col, 'MeanFD', 'TDProp', 'Subjects', 'Drug')])
  currModel_tdprop_cov_drug <- lme(as.formula(formula_str_tdprop_cov_drug), random = ~ 1 | Subjects, data = df_tdprop_cov_drug)
  corvec_tdprop_cov_drug[i - 39] <- summary(currModel_tdprop_cov_drug)$tTable[rownames(summary(currModel_tdprop_cov_drug)$tTable) == "TDProp", "t-value"]
  pvec_tdprop_cov_drug[i - 39] <- summary(currModel_tdprop_cov_drug)$tTable[rownames(summary(currModel_tdprop_cov_drug)$tTable) == "TDProp", "p-value"]
  colNameVec_tdprop_cov_drug[i - 39] <- colnames(VASmerge)[i]
  
  formula_str_drug_cov_tdprop <- paste(das_col, "~ MeanFD + Drug + TDProp")
  df_drug_cov_tdprop <- na.omit(VASmerge[, c(das_col, 'MeanFD', 'Drug', 'Subjects', 'TDProp')])
  currModel_drug_cov_tdprop <- lme(as.formula(formula_str_drug_cov_tdprop), random = ~ 1 | Subjects, data = df_drug_cov_tdprop)
  corvec_drug_cov_tdprop[i - 39] <- summary(currModel_drug_cov_tdprop)$tTable[rownames(summary(currModel_drug_cov_tdprop)$tTable) == "Drug1", "t-value"]
  pvec_drug_cov_tdprop[i - 39] <- summary(currModel_drug_cov_tdprop)$tTable[rownames(summary(currModel_drug_cov_tdprop)$tTable) == "Drug1", "p-value"]
  print(summary(currModel_tdprop_cov_drug)$tTable)
  print(summary(currModel_drug_cov_tdprop)$tTable)
}
# merge into tdprop df
df_tdprop2=df_tdprop
df_tdprop2$Values=corvec_tdprop_cov_drug
# Create a dataframe with the values and column names for TD, COV DRUG
df_tdprop_cov_drug <- data.frame(Values = corvec_tdprop_cov_drug, ColumnNames = colNameVec_tdprop_cov_drug)
df_tdprop_cov_drug$ColumnNames <- factor(df_tdprop_cov_drug$ColumnNames, levels = df_tdprop_cov_drug$ColumnNames[order(df_tdprop_cov_drug$Values, decreasing = FALSE)])
# make a color vector by significance
fdrp_tdprop_cov_drug <- p.adjust(pvec_tdprop_cov_drug, method = 'fdr')
colorvec_tdprop_cov_drug <- rep('NS', length(fdrp_tdprop_cov_drug))
colorvec_tdprop_cov_drug[pvec_tdprop_cov_drug < .05] <- 'Uncr'
colorvec_tdprop_cov_drug[fdrp_tdprop_cov_drug < .05] <- 'FDR'
# merge into tdprop df
df_tdprop2$Sig <- factor(colorvec_tdprop_cov_drug, levels = c('NS', 'Uncr', 'FDR'))
df_tdpropBoth=rbind(df_tdprop,df_tdprop2)
df_tdpropBoth$Covarying=ones(34,1)
df_tdpropBoth$Covarying[1:17]=0
df_tdpropBoth$Covarying=as.factor(df_tdpropBoth$Covarying)
# merge into Drug df
df_drug2=df_drug
df_drug2$Values=corvec_drug_cov_tdprop
# Create a dataframe with the values and column names for DRUG, COV TD
df_drug_cov_tdprop <- data.frame(Values = corvec_drug_cov_tdprop, ColumnNames = colNameVec_tdprop_cov_drug)
df_drug_cov_tdprop$ColumnNames <- factor(df_drug_cov_tdprop$ColumnNames, levels = df_drug_cov_tdprop$ColumnNames[order(df_drug_cov_tdprop$Values, decreasing = FALSE)])
# make a color vector by significance
fdrp_drug_cov_tdprop <- p.adjust(pvec_drug_cov_tdprop, method = 'fdr')
colorvec_drug_cov_tdprop <- rep('NS', length(fdrp_drug_cov_tdprop))
colorvec_drug_cov_tdprop[pvec_drug_cov_tdprop < .05] <- 'Uncr'
colorvec_drug_cov_tdprop[fdrp_drug_cov_tdprop < .05] <- 'FDR'
# merge into Drug df
df_drug2$Sig <- factor(colorvec_drug_cov_tdprop, levels = c('NS', 'Uncr', 'FDR'))
df_DrugBoth=rbind(df_drug,df_drug2)
df_DrugBoth$Covarying=ones(34,1)
df_DrugBoth$Covarying[1:17]=0
df_DrugBoth$Covarying=as.factor(df_DrugBoth$Covarying)
# Specify color scale manually
colors <- c('NS' = 'gray', 'Uncr' = 'blue', 'FDR' = 'red')

# Create the plot using ggplot for TD PROP
plot_tdprop <- ggplot(df_tdpropBoth, aes(x = Values, y = ColumnNames, color = Sig,shape=Covarying)) +
  geom_point(size = 3) +
  geom_line(aes(group = ColumnNames), linetype = "solid") +
  xlim(-15, 15) +
  scale_color_manual(values = colors) +
  labs(x = "t-Values", y = "DAS Questions", title = "Association with TD Props") +
  theme_minimal(base_size = 26)

# Create the plot using ggplot for DRUG
plot_drug <- ggplot(df_DrugBoth, aes(x = Values, y = ColumnNames, color = Sig,shape=Covarying)) +
  geom_point(size = 3) +
  geom_line(aes(group = ColumnNames), linetype = "solid") +
  xlim(-15, 15) +
  scale_color_manual(values = colors) +
  labs(x = "t-Values", y = "DAS Questions", title = "Association with Drug") +
  theme_minimal(base_size = 26)

# Combine the plots
gridExtra::grid.arrange(plot_tdprop, plot_drug, ncol = 2)

```

```{r}
# load in vas
els=read.csv('~/Downloads/MDMA_Questionnaires_baseline.csv')
# correct subject naming
els$Subjects <- paste0("sub-MDMA", sprintf("%03d", els$Subjects))
testV=merge(els,test,by=c("Subjects"))

```




```{r}
# Amyg DMN Fc
rs1=read.csv('~/Downloads/P50 MDMA/rs1_DMN_AmygFC_Merged.csv',header=F)
rs2=read.csv('~/Downloads/P50 MDMA/rs2_DMN_AmygFC_Merged.csv',header=F)
emo=read.csv('~/Downloads/P50 MDMA/emotion_DMN_AmygFC_Merged.csv',header=F)
gambling=read.csv('~/Downloads/P50 MDMA/gambling_DMN_AmygFC_Merged.csv',header=F)
wm=read.csv('~/Downloads/P50 MDMA/wm_DMN_AmygFC_Merged.csv',header=F)
noncon=read.csv('~/Downloads/P50 MDMA/nonconscious_DMN_AmygFC_Merged.csv',header=F)
con=read.csv('~/Downloads/P50 MDMA/conscious_DMN_AmygFC_Merged.csv',header=F)
gng=read.csv('~/Downloads/P50 MDMA/gonogo_DMN_AmygFC_Merged.csv',header=F)
# set colnames
#colnames(rs1)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(rs2)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(emo)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(gambling)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
#colnames(wm)=c('bvProp','pProp','m1Prop','m2Prop','bvTRs','pTRs','m1TRs','m2TRs')
rs1$Task='rs'
rs2$Task='rs2'
emo$Task='emotion'
gambling$Task='gambling'
wm$Task='wm'
noncon$Task='nonconscious'
con$Task='conscious'
gng$Task='gonogo'

# remove subj 4
rs1=rs1[-c(4),]
rs2=rs2[-c(4),]
emo=emo[-c(4),]
gambling=gambling[-c(4),]
wm=wm[-c(4),]
noncon=noncon[-c(4),]
con=con[-c(4),]
gng=gng[-c(4),]

# this is going to be ugly but simple
# manually pair columns as sep. observations of baseline, placebo, 80, 120mg
rs1bv=data.frame(cbind(rs1$V1,rs1$V5))
rs1p=data.frame(cbind(rs1$V2,rs1$V6))
rs1m1=data.frame(cbind(rs1$V3,rs1$V7))
rs1m2=data.frame(cbind(rs1$V4,rs1$V8))
colnames(rs1bv)=c('TDProp','RemTRs')
colnames(rs1p)=c('TDProp','RemTRs')
colnames(rs1m1)=c('TDProp','RemTRs')
colnames(rs1m2)=c('TDProp','RemTRs')

rs2bv=data.frame(cbind(rs2$V1,rs2$V5))
rs2p=data.frame(cbind(rs2$V2,rs2$V6))
rs2m1=data.frame(cbind(rs2$V3,rs2$V7))
rs2m2=data.frame(cbind(rs2$V4,rs2$V8))
colnames(rs2bv)=c('TDProp','RemTRs')
colnames(rs2p)=c('TDProp','RemTRs')
colnames(rs2m1)=c('TDProp','RemTRs')
colnames(rs2m2)=c('TDProp','RemTRs')

emobv=data.frame(cbind(emo$V1,emo$V5))
emop=data.frame(cbind(emo$V2,emo$V6))
emom1=data.frame(cbind(emo$V3,emo$V7))
emom2=data.frame(cbind(emo$V4,emo$V8))
colnames(emobv)=c('TDProp','RemTRs')
colnames(emop)=c('TDProp','RemTRs')
colnames(emom1)=c('TDProp','RemTRs')
colnames(emom2)=c('TDProp','RemTRs')

gamblingbv=data.frame(cbind(gambling$V1,gambling$V5))
gamblingp=data.frame(cbind(gambling$V2,gambling$V6))
gamblingm1=data.frame(cbind(gambling$V3,gambling$V7))
gamblingm2=data.frame(cbind(gambling$V4,gambling$V8))
colnames(gamblingbv)=c('TDProp','RemTRs')
colnames(gamblingp)=c('TDProp','RemTRs')
colnames(gamblingm1)=c('TDProp','RemTRs')
colnames(gamblingm2)=c('TDProp','RemTRs')

wmbv=data.frame(cbind(wm$V1,wm$V5))
wmp=data.frame(cbind(wm$V2,wm$V6))
wmm1=data.frame(cbind(wm$V3,wm$V7))
wmm2=data.frame(cbind(wm$V4,wm$V8))
colnames(wmbv)=c('TDProp','RemTRs')
colnames(wmp)=c('TDProp','RemTRs')
colnames(wmm1)=c('TDProp','RemTRs')
colnames(wmm2)=c('TDProp','RemTRs')

nonconbv=data.frame(cbind(noncon$V1,noncon$V5))
nonconp=data.frame(cbind(noncon$V2,noncon$V6))
nonconm1=data.frame(cbind(noncon$V3,noncon$V7))
nonconm2=data.frame(cbind(noncon$V4,noncon$V8))
colnames(nonconbv)=c('TDProp','RemTRs')
colnames(nonconp)=c('TDProp','RemTRs')
colnames(nonconm1)=c('TDProp','RemTRs')
colnames(nonconm2)=c('TDProp','RemTRs')

conbv=data.frame(cbind(con$V1,con$V5))
conp=data.frame(cbind(con$V2,con$V6))
conm1=data.frame(cbind(con$V3,con$V7))
conm2=data.frame(cbind(con$V4,con$V8))
colnames(conbv)=c('TDProp','RemTRs')
colnames(conp)=c('TDProp','RemTRs')
colnames(conm1)=c('TDProp','RemTRs')
colnames(conm2)=c('TDProp','RemTRs')

gngbv=data.frame(cbind(gng$V1,gng$V5))
gngp=data.frame(cbind(gng$V2,gng$V6))
gngm1=data.frame(cbind(gng$V3,gng$V7))
gngm2=data.frame(cbind(gng$V4,gng$V8))
colnames(gngbv)=c('TDProp','RemTRs')
colnames(gngp)=c('TDProp','RemTRs')
colnames(gngm1)=c('TDProp','RemTRs')
colnames(gngm2)=c('TDProp','RemTRs')

# get subject IDs from this rds
alff=readRDS('~/OutPlacDrug_alff.rds')
rs1bv$Subjects=alff$SubjID
rs1p$Subjects=alff$SubjID
rs1m1$Subjects=alff$SubjID
rs1m2$Subjects=alff$SubjID

rs2bv$Subjects=alff$SubjID
rs2p$Subjects=alff$SubjID
rs2m1$Subjects=alff$SubjID
rs2m2$Subjects=alff$SubjID

emobv$Subjects=alff$SubjID
emop$Subjects=alff$SubjID
emom1$Subjects=alff$SubjID
emom2$Subjects=alff$SubjID

gamblingbv$Subjects=alff$SubjID
gamblingp$Subjects=alff$SubjID
gamblingm1$Subjects=alff$SubjID
gamblingm2$Subjects=alff$SubjID

wmbv$Subjects=alff$SubjID
wmp$Subjects=alff$SubjID
wmm1$Subjects=alff$SubjID
wmm2$Subjects=alff$SubjID

nonconbv$Subjects=alff$SubjID
nonconp$Subjects=alff$SubjID
nonconm1$Subjects=alff$SubjID
nonconm2$Subjects=alff$SubjID

conbv$Subjects=alff$SubjID
conp$Subjects=alff$SubjID
conm1$Subjects=alff$SubjID
conm2$Subjects=alff$SubjID

gngbv$Subjects=alff$SubjID
gngp$Subjects=alff$SubjID
gngm1$Subjects=alff$SubjID
gngm2$Subjects=alff$SubjID

# add in task (rs to be made equivalent after motion merge)
rs1bv$Task='rs'
rs1p$Task='rs'
rs1m1$Task='rs'
rs1m2$Task='rs'

rs2bv$Task='rs2'
rs2p$Task='rs2'
rs2m1$Task='rs2'
rs2m2$Task='rs2'

emobv$Task='emotion'
emop$Task='emotion'
emom1$Task='emotion'
emom2$Task='emotion'

gamblingbv$Task='gambling'
gamblingp$Task='gambling'
gamblingm1$Task='gambling'
gamblingm2$Task='gambling'

wmbv$Task='wm'
wmp$Task='wm'
wmm1$Task='wm'
wmm2$Task='wm'

nonconbv$Task='nonconscious'
nonconp$Task='nonconscious'
nonconm1$Task='nonconscious'
nonconm2$Task='nonconscious'

conbv$Task='conscious'
conp$Task='conscious'
conm1$Task='conscious'
conm2$Task='conscious'

gngbv$Task='gonogo'
gngp$Task='gonogo'
gngm1$Task='gonogo'
gngm2$Task='gonogo'

# add in dosage
rs1bv$Dosage='baseline'
rs1p$Dosage='Placebo'
rs1m1$Dosage='80mg'
rs1m2$Dosage='120mg'

rs2bv$Dosage='baseline'
rs2p$Dosage='Placebo'
rs2m1$Dosage='80mg'
rs2m2$Dosage='120mg'

emobv$Dosage='baseline'
emop$Dosage='Placebo'
emom1$Dosage='80mg'
emom2$Dosage='120mg'

gamblingbv$Dosage='baseline'
gamblingp$Dosage='Placebo'
gamblingm1$Dosage='80mg'
gamblingm2$Dosage='120mg'

wmbv$Dosage='baseline'
wmp$Dosage='Placebo'
wmm1$Dosage='80mg'
wmm2$Dosage='120mg'

nonconbv$Dosage='baseline'
nonconp$Dosage='Placebo'
nonconm1$Dosage='80mg'
nonconm2$Dosage='120mg'

conbv$Dosage='baseline'
conp$Dosage='Placebo'
conm1$Dosage='80mg'
conm2$Dosage='120mg'

gngbv$Dosage='baseline'
gngp$Dosage='Placebo'
gngm1$Dosage='80mg'
gngm2$Dosage='120mg'

# combine all
allScans=rbind(rs1bv,rs1p,rs1m1,rs1m2,rs2bv,rs2p,rs2m1,rs2m2,emobv,emop,emom1,emom2,gamblingbv,gamblingp,gamblingm1,gamblingm2,wmbv,wmp,wmm1,wmm2,nonconbv,nonconp,nonconm1,nonconm2,conbv,conp,conm1,conm2,gngbv,gngp,gngm1,gngm2)

# read in motion
mot=read.csv('~/Desktop/MDMA_spikes_summary.csv')

# motion merge
mergedDf=merge(mot,allScans,by=c('Subjects','Task','Dosage'))
mergedDf$Drug=0
mergedDf$Drug[mergedDf$Dosage=="120mg"]=1
mergedDf$Drug[mergedDf$Dosage=="80mg"]=1
mergedDf$Drug=as.factor(mergedDf$Drug)
mergedDfFC=mergedDf

# code rs as one task
mergedDfFC$Task[mergedDfFC$Task=='rs1']='rs'
mergedDfFC$Task[mergedDfFC$Task=='rs2']='rs'
# set rs to reference
mergedDfFC$Task<-as.factor(mergedDfFC$Task)
mergedDfFC$Task <- relevel(mergedDfFC$Task, ref = "rs")
# remove >.3 fd
mergedDfFC=mergedDfFC[mergedDfFC$MeanFD<.3,]
```

```{r}
# test if amyg DMN FC changes after dose
# group by time interaction
# group 1 is placebo second visit
# group 2 is placebo after second visit
# expecting FC to go down with time in second group
# manually delineate groups
mergedDfFC$Group=1
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA002']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA004']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA008']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA009']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA011']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA015']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA017']=3
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA005']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA006']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA007']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA010']=2
mergedDfFC$Group[mergedDfFC$Subjects=='sub-MDMA014']=2
mergedDfFC$Group=as.factor(mergedDfFC$Group)
# PTs to eliminate for consistency (4 already excluded)
mergedDfFC=mergedDfFC[mergedDfFC$Subjects!='sub-MDMA006',]
mergedDfFC=mergedDfFC[mergedDfFC$Subjects!='sub-MDMA010',]
# eliminate drug visits
mergedDfFC_sob=mergedDfFC[mergedDfFC$Drug==0,]
# get change 
# make name accurate
mergedDfFC_sob$AmyFC=mergedDfFC_sob$TDProp


model <- lme(AmyFC ~ MeanFD +Task+ Group*Dosage,random = ~ 1 | Subjects,data = mergedDfFC_sob)

sjPlot::plot_model(model, type = "eff",show.values = T)
sjPlot::plot_model(model, type = "int")
```
